# 前端导航地图人机交互功能说明

## 功能概述

本次更新完善了前端导航地图部分的人机交互功能，实现了以下6大核心功能：

### 1. 障碍物信息可视化 ✅

**实现方式:**
- 后端订阅 `/map` 话题 (OccupancyGrid类型)
- 前端实时接收并绘制栅格地图
- 白色表示障碍物，灰色表示未知区域

**关键代码:**
- 后端: `map_callback()` 和 `map_sub`
- 前端: `drawMapData()` 函数

### 2. 规划路径可视化 ✅

**实现方式:**
- 后端订阅 `/cleaning/planned_path` 话题 (Path类型)
- 前端使用黄色虚线绘制清扫规划路径
- 清扫模式(沿边、弓形、全屋)启动后自动显示路径

**关键代码:**
- 后端: `planned_path_callback()` 和 `planned_path_sub`
- 前端: `drawPlannedPath()` 函数

### 3. 目标点区分显示 ✅

**实现方式:**
- **用户目标点**: 绿色圆圈，带"目标"标签
- **执行目标点**: 红色圆圈，带"执行中"标签
- 两者分开显示，避免混淆

**关键代码:**
- 后端: `user_goal` 和 `current_goal` 变量
- 前端: `drawUserGoal()` 和 `drawCurrentGoal()` 函数

### 4. TF位姿 + 自动居中 + 缩放控制 ✅

**实现方式:**
- 后端通过TF监听器获取 `base_link` 到 `map` 的变换
- 前端优先使用TF位姿绘制机器人
- 添加自动居中功能，机器人始终保持在画布中央
- 提供 `+`、`-`、`📍` 三个控制按钮

**按钮功能:**
- `+`: 放大地图 (缩放倍率 × 1.2)
- `-`: 缩小地图 (缩放倍率 ÷ 1.2)
- `📍`: 切换自动居中开关 (激活时高亮显示)

**关键代码:**
- 后端: `update_robot_pose_from_tf()` 和 `tf_buffer`
- 前端: `zoomIn()`, `zoomOut()`, `toggleAutoCenter()`

### 5. 清扫进度可视化 ✅

**实现方式:**
- 后端订阅 `/cleaning/task_info` 话题解析进度
- 在地图左上角叠加层显示进度信息
- 格式: `5/10 (50.0%)`

**关键代码:**
- 后端: `cleaning_progress_callback()`
- 前端: `updateCleaningProgressDisplay()`

### 6. AMCL初始化 + 导航目标点发布 ✅

**操作流程:**

#### AMCL初始化 (两次点击)
1. **第一次点击**: 确定机器人位置
   - 地图上显示蓝色闪烁标记
   - 提示: "点击设置方向 ➜"
2. **第二次点击**: 确定机器人朝向
   - 自动计算角度并发布到 `/initialpose` 话题
   - 完成AMCL粒子滤波器初始化

#### 导航目标点发布
- 完成AMCL初始化后，后续点击都发布为导航目标点
- 自动转换坐标系 (canvas → map)
- 发布到 `/goal_pose` 话题

**注意事项:**
- 必须先切换到**导航模式**才能点击地图
- 清扫模式下禁止手动发布目标点
- 用户目标点(绿色)和执行目标点(红色)分开显示

**关键代码:**
- 后端: `initial_pose_pub`, `goal_pose_pub`
- 前端: `handleMapClick()` 函数

---

## 测试步骤

### 启动系统
```bash
# 终端1: 启动基础控制
ros2 launch cleanbot_control cleanbot.launch.py

# 终端2: 启动导航系统
ros2 launch cleanbot_navigation navigation_sim.launch.py

# 浏览器访问
http://localhost:8080
```

### 测试建图模式
1. 切换到"建图模式"
2. 使用摇杆控制机器人移动
3. 观察地图实时构建(白色障碍物)
4. 点击"保存当前地图"

### 测试导航模式
1. 切换到"导航模式"
2. 选择已保存的地图
3. **AMCL初始化**:
   - 第一次点击地图设置位置
   - 第二次点击设置方向
4. 观察机器人位姿对齐
5. 点击地图发布导航目标点
6. 观察机器人自主导航

### 测试清扫模式
1. 确保在"导航模式"
2. 选择工作模式: "自动全屋"、"沿边"或"弓形"
3. 观察:
   - 黄色虚线显示规划路径
   - 左上角显示清扫进度
   - 红色圆圈显示当前执行的目标点

### 测试地图控制
1. 点击 `+` 放大地图
2. 点击 `-` 缩小地图
3. 点击 `📍` 切换自动居中
   - 开启: 机器人始终在画布中央
   - 关闭: 可以手动查看地图其他区域

---

## 技术要点

### 坐标系转换
```javascript
// Canvas坐标 → 世界坐标 (map)
const worldX = (canvasX - mapOffset.x) / mapScale;
const worldY = -(canvasY - mapOffset.y) / mapScale;  // Y轴反向

// 世界坐标 → Canvas坐标
const canvasX = worldX * mapScale + mapOffset.x;
const canvasY = -worldY * mapScale + mapOffset.y;
```

### 四元数 → 欧拉角
```javascript
// Yaw角度计算
const siny_cosp = 2 * (qw * qz + qx * qy);
const cosy_cosp = 1 - 2 * (qy * qy + qz * qz);
const yaw = Math.atan2(siny_cosp, cosy_cosp);
```

### TF查询
```python
# 查询base_link到map的变换
transform = self.tf_buffer.lookup_transform(
    'map',           # 目标坐标系
    'base_link',     # 源坐标系
    rclpy.time.Time(),
    timeout=rclpy.duration.Duration(seconds=0.1)
)
```

---

## 图例说明

| 颜色/符号 | 含义 |
|----------|------|
| 🟦 蓝色机器人 | 当前机器人位置(带方向箭头) |
| 🟩 绿色圆圈 | 用户设置的目标点 |
| 🟥 红色圆圈 | 导航实际执行的目标点 |
| 🟨 黄色虚线 | 清扫规划路径 |
| ⬜ 白色方格 | 地图障碍物 |
| 🔵 蓝色闪烁 | AMCL初始化临时标记 |

---

## 已知问题和注意事项

1. **地图渲染性能**: 大地图可能导致绘制卡顿，已优化为只绘制占用和未知格子
2. **TF延迟**: TF查询失败时自动回退到里程计位姿
3. **清扫进度**: 需要清扫任务节点发布 `progress:X/Y` 格式的消息
4. **AMCL初始化**: 必须在导航模式下进行，建图模式下不可用

---

## 更新的文件清单

### 后端
- `src/cleanbot_control/scripts/web_control_node.py`
  - 添加地图、路径、TF订阅
  - 添加AMCL初始化和目标点发布
  - 添加清扫进度解析

### 前端
- `src/cleanbot_control/web/static/control.js`
  - 更新地图绘制逻辑
  - 添加AMCL初始化交互
  - 添加缩放和自动居中控制
  - 区分用户目标点和执行目标点

- `src/cleanbot_control/web/templates/index.html`
  - 添加缩放控制按钮
  - 添加清扫进度显示区域
  - 更新图例说明

---

## 后续优化建议

1. **地图缓存**: 对地图数据进行缓存，避免重复绘制
2. **路径动画**: 为规划路径添加动画效果
3. **触摸支持**: 优化移动端触摸交互
4. **多点导航**: 支持连续发布多个导航点
5. **清扫区域选择**: 允许用户在地图上框选清扫区域

---

**完成时间**: 2025-12-26
**作者**: AI Assistant

