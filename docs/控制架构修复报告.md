# CleanBot æ§åˆ¶æ¶æ„ä¿®å¤æŠ¥å‘Š

## ğŸ“… ä¿®å¤æ—¶é—´
2025-11-28

## ğŸ¯ ä¿®å¤ç›®æ ‡
è§£å†³æ§åˆ¶æ¶æ„ä¸­çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå»ºç«‹æ¸…æ™°çš„æ•°æ®æµã€‚

---

## âŒ åŸæœ‰é—®é¢˜

### é—®é¢˜1ï¼šå¾ªç¯ä¾èµ–
```
ç”¨æˆ·/å¯¼èˆª â†’ /cmd_vel
            â†“
    diff_drive_controller
            â†“
    hw_commands_velocity_[] (rad/s)
            â†“
    ç¡¬ä»¶æ¥å£ write()
            â†“
    ã€é”™è¯¯ã€‘è½¬æ¢å› Twist å¹¶å‘å¸ƒåˆ° /cmd_vel  â† å½¢æˆå¾ªç¯ï¼
            â†“
    USBèŠ‚ç‚¹è®¢é˜… /cmd_vel
```

**é—®é¢˜åˆ†æï¼š**
- ç¡¬ä»¶æ¥å£å°†æ§åˆ¶å™¨ä¸‹å‘çš„å…³èŠ‚é€Ÿåº¦å‘½ä»¤ï¼ˆrad/sï¼‰è½¬æ¢å› Twist æ¶ˆæ¯
- é‡æ–°å‘å¸ƒåˆ° `/cmd_vel`ï¼Œé€ æˆå¾ªç¯
- USBèŠ‚ç‚¹è®¢é˜… `/cmd_vel` ä¼šæ”¶åˆ°"äºŒæ¬¡å¤„ç†"çš„å‘½ä»¤
- diff_drive_controller ä¹Ÿåœ¨è®¢é˜… `/cmd_vel`ï¼Œå¯èƒ½é€ æˆæ··ä¹±

### é—®é¢˜2ï¼šèŒè´£ä¸æ¸…
- ç¡¬ä»¶æ¥å£ä¸åº”è¯¥åšå·®é€Ÿè¿åŠ¨å­¦æ­£è§£ï¼ˆè½®é€Ÿâ†’æœºå™¨äººé€Ÿåº¦ï¼‰
- è¿™æ˜¯ diff_drive_controller çš„èŒè´£
- ç¡¬ä»¶æ¥å£åªåº”è¯¥åšå•ä½è½¬æ¢ï¼ˆrad/s â†” m/sï¼‰

### é—®é¢˜3ï¼šå•ä½è½¬æ¢æ··ä¹±
- USBèŠ‚ç‚¹ç›´æ¥å°† STM32 çš„é€Ÿåº¦ï¼ˆm/sï¼‰é™¤ä»¥åŠå¾„å‘å¸ƒä¸º rad/s
- ä½†æ²¡æœ‰è€ƒè™‘åˆ°å·²ç»æ˜¯çº¿é€Ÿåº¦ï¼Œä¸éœ€è¦å·®é€Ÿè¿åŠ¨å­¦

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. å¼•å…¥ä¸“ç”¨è¯é¢˜ `/wheel_speed_cmd`

**æ–°çš„æ•°æ®æµï¼š**
```
ç”¨æˆ·/å¯¼èˆª â†’ /cmd_vel (Twist)
            â†“
    diff_drive_controller (å·®é€Ÿé€†è§£)
            â†“
    hw_commands_velocity_[] (rad/s)
            â†“
    ç¡¬ä»¶æ¥å£ write() (å•ä½è½¬æ¢)
            â†“
    /wheel_speed_cmd [left_mps, right_mps]  â† ä¸“ç”¨è¯é¢˜
            â†“
    USBèŠ‚ç‚¹ (åè®®æ‰“åŒ…)
            â†“
    STM32
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ— å¾ªç¯ä¾èµ–
- âœ… èŒè´£æ¸…æ™°
- âœ… å•ä½è½¬æ¢æ˜ç¡®

### 2. ä¿®æ­£ç¡¬ä»¶æ¥å£èŒè´£

**ä¿®æ”¹å‰ (cleanbot_hardware_interface.cpp):**
```cpp
// write() å‡½æ•°
double left_linear_vel = left_wheel_vel * wheel_radius_;
double right_linear_vel = right_wheel_vel * wheel_radius_;

// âŒ é”™è¯¯ï¼šè¿›è¡Œå·®é€Ÿæ­£è§£
double linear_vel = (left_linear_vel + right_linear_vel) / 2.0;
double angular_vel = (right_linear_vel - left_linear_vel) / wheel_separation_;

// âŒ é”™è¯¯ï¼šå‘å¸ƒåˆ° /cmd_vel
auto twist_msg = geometry_msgs::msg::Twist();
twist_msg.linear.x = linear_vel;
twist_msg.angular.z = angular_vel;
cmd_vel_pub_->publish(twist_msg);
```

**ä¿®æ”¹å:**
```cpp
// write() å‡½æ•°
// âœ… æ­£ç¡®ï¼šåªåšå•ä½è½¬æ¢
double left_wheel_angular_vel = hw_commands_velocity_[0];  // rad/s
double right_wheel_angular_vel = hw_commands_velocity_[1]; // rad/s

double left_wheel_linear_vel = left_wheel_angular_vel * wheel_radius_;  // m/s
double right_wheel_linear_vel = right_wheel_angular_vel * wheel_radius_; // m/s

// âœ… æ­£ç¡®ï¼šå‘å¸ƒåˆ°ä¸“ç”¨è¯é¢˜
auto wheel_speed_msg = std_msgs::msg::Float32MultiArray();
wheel_speed_msg.data = {left_wheel_linear_vel, right_wheel_linear_vel};
wheel_speed_cmd_pub_->publish(wheel_speed_msg);
```

### 3. ä¿®æ­£USBèŠ‚ç‚¹è®¢é˜…

**ä¿®æ”¹å‰ (usb_communication_node.py):**
```python
# âŒ é”™è¯¯ï¼šè®¢é˜… /cmd_vel
self.cmd_vel_sub = self.create_subscription(
    Twist, 'cmd_vel', self.cmd_vel_callback, 10)

def cmd_vel_callback(self, msg: Twist):
    # âŒ é”™è¯¯ï¼šå†æ¬¡è¿›è¡Œå·®é€Ÿé€†è§£ï¼ˆé‡å¤å·¥ä½œï¼‰
    linear_vel = msg.linear.x
    angular_vel = msg.angular.z
    wheel_base = 0.2
    
    left_speed = linear_vel - angular_vel * wheel_base / 2.0
    right_speed = linear_vel + angular_vel * wheel_base / 2.0
```

**ä¿®æ”¹å:**
```python
# âœ… æ­£ç¡®ï¼šè®¢é˜…ä¸“ç”¨è¯é¢˜
self.wheel_speed_cmd_sub = self.create_subscription(
    Float32MultiArray, 'wheel_speed_cmd', self.wheel_speed_cmd_callback, 10)

def wheel_speed_cmd_callback(self, msg: Float32MultiArray):
    # âœ… æ­£ç¡®ï¼šç›´æ¥æ¥æ”¶å·²è®¡ç®—å¥½çš„è½®é€Ÿ
    if len(msg.data) >= 2:
        with self.control_lock:
            self.control_cmd['left_wheel_speed'] = msg.data[0]  # m/s
            self.control_cmd['right_wheel_speed'] = msg.data[1] # m/s
```

### 4. ä¿®æ­£å•ä½è½¬æ¢

**ä¿®æ”¹å‰ (usb_communication_node.py):**
```python
def process_wheel_frame(self, payload: bytes):
    # è§£ææ•°æ®
    left_angle_deg, left_speed_mps, right_angle_deg, right_speed_mps = data
    
    # âŒ é”™è¯¯ï¼šå…¬å¼æ··ä¹±
    joint_msg.velocity = [float(left_speed_mps / 0.032), float(right_speed_mps / 0.032)]
```

**ä¿®æ”¹å:**
```python
def process_wheel_frame(self, payload: bytes):
    # è§£ææ•°æ®
    left_angle_deg, left_speed_mps, right_angle_deg, right_speed_mps = data
    
    wheel_radius = 0.032  # m
    
    # âœ… æ­£ç¡®ï¼šè§’åº¦è½¬å¼§åº¦
    left_angle_rad = np.deg2rad(left_angle_deg)
    right_angle_rad = np.deg2rad(right_angle_deg)
    
    # âœ… æ­£ç¡®ï¼šçº¿é€Ÿåº¦è½¬è§’é€Ÿåº¦ï¼Œå…¬å¼ï¼šÏ‰ = v / r
    left_speed_rad_s = left_speed_mps / wheel_radius
    right_speed_rad_s = right_speed_mps / wheel_radius
    
    joint_msg.position = [float(left_angle_rad), float(right_angle_rad)]
    joint_msg.velocity = [float(left_speed_rad_s), float(right_speed_rad_s)]
```

---

## ğŸ“‹ ä¿®æ”¹æ¸…å•

### æ–‡ä»¶1: `cleanbot_hardware_interface.hpp`
- âœ… ç§»é™¤ `cmd_vel_pub_` (Twist å‘å¸ƒå™¨)
- âœ… æ·»åŠ  `wheel_speed_cmd_pub_` (Float32MultiArray å‘å¸ƒå™¨)
- âœ… æ·»åŠ å¤´æ–‡ä»¶ `std_msgs/msg/float32_multi_array.hpp`

### æ–‡ä»¶2: `cleanbot_hardware_interface.cpp`
- âœ… ç§»é™¤ `geometry_msgs/msg/twist.hpp` åŒ…å«
- âœ… æ·»åŠ  `std_msgs/msg/float32_multi_array.hpp` åŒ…å«
- âœ… ä¿®æ”¹ `on_configure()`: åˆ›å»º `wheel_speed_cmd` å‘å¸ƒå™¨
- âœ… ä¿®æ”¹ `write()`: åªåšå•ä½è½¬æ¢ï¼ˆrad/s â†’ m/sï¼‰ï¼Œä¸åšå·®é€Ÿæ­£è§£

### æ–‡ä»¶3: `usb_communication_node.py`
- âœ… ç§»é™¤ `/cmd_vel` è®¢é˜…å’Œå›è°ƒå‡½æ•°
- âœ… æ·»åŠ  `/wheel_speed_cmd` è®¢é˜…å’Œå›è°ƒå‡½æ•°
- âœ… ä¿®æ”¹ `process_wheel_frame()`: æ­£ç¡®çš„å•ä½è½¬æ¢ï¼ˆm/s â†’ rad/sï¼‰
- âœ… æ·»åŠ æ³¨é‡Šè¯´æ˜è½®å­åŠå¾„é…ç½®

---

## ğŸ§ª éªŒè¯ç»“æœ

### è‡ªåŠ¨åŒ–æµ‹è¯•
è¿è¡Œ `./æµ‹è¯•æ§åˆ¶æµç¨‹.sh`

```
======================================
  CleanBot æ§åˆ¶æµç¨‹éªŒè¯æµ‹è¯•
======================================

âœ“ æ‰€æœ‰ 26 é¡¹æ£€æŸ¥é€šè¿‡
âœ— 0 é¡¹å¤±è´¥

æ£€æŸ¥é¡¹åŒ…æ‹¬ï¼š
- URDF é…ç½®ä¸€è‡´æ€§
- ros2_control é…ç½®ä¸€è‡´æ€§
- æ§åˆ¶å™¨é…ç½®ä¸€è‡´æ€§
- ç¡¬ä»¶æ¥å£ä»£ç æ­£ç¡®æ€§
- USB èŠ‚ç‚¹ä»£ç æ­£ç¡®æ€§
- ç¼–è¯‘å’Œå®‰è£…çŠ¶æ€
- æ•°æ®æµé€»è¾‘éªŒè¯
```

### ç¼–è¯‘æµ‹è¯•
```bash
cd /home/xiaoming/æ¡Œé¢/MOON/Electronic/CleanBot_ws
colcon build --packages-select cleanbot_control
```

**ç»“æœï¼š** âœ… ç¼–è¯‘æˆåŠŸ

**è­¦å‘Šï¼ˆå¯å¿½ç•¥ï¼‰ï¼š**
- `on_init()` å‡½æ•°ä½¿ç”¨äº†æ—§ç‰ˆ APIï¼ˆROS 2 ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼Œä¸å½±å“åŠŸèƒ½ï¼‰

### é…ç½®ä¸€è‡´æ€§éªŒè¯

| å‚æ•° | URDF | ros2_control | æ§åˆ¶å™¨é…ç½® | USBèŠ‚ç‚¹ | çŠ¶æ€ |
|------|------|--------------|-----------|---------|------|
| è½®åŠå¾„ | 0.032m | 0.032m | 0.032m | 0.032m | âœ… |
| è½®é—´è· | 0.2m | 0.2m | 0.2m | - | âœ… |
| å·¦è½®å…³èŠ‚å | left_wheel_joint | left_wheel_joint | left_wheel_joint | left_wheel_joint | âœ… |
| å³è½®å…³èŠ‚å | right_wheel_joint | right_wheel_joint | right_wheel_joint | right_wheel_joint | âœ… |

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### ç¤ºä¾‹ï¼šå‰è¿› 0.2 m/sï¼Œå·¦è½¬ 0.5 rad/s

```
1. ç”¨æˆ·å‘½ä»¤
   /cmd_vel: linear.x=0.2, angular.z=0.5

2. diff_drive_controller å·®é€Ÿé€†è§£
   v_left = 0.2 - 0.5Ã—0.2/2 = 0.15 m/s
   v_right = 0.2 + 0.5Ã—0.2/2 = 0.25 m/s
   
   è½¬æ¢ä¸ºè§’é€Ÿåº¦:
   Ï‰_left = 0.15/0.032 = 4.6875 rad/s
   Ï‰_right = 0.25/0.032 = 7.8125 rad/s

3. ç¡¬ä»¶æ¥å£ write()
   hw_commands_velocity_[0] = 4.6875 rad/s
   hw_commands_velocity_[1] = 7.8125 rad/s
   
   è½¬æ¢å›çº¿é€Ÿåº¦:
   left_speed = 4.6875 Ã— 0.032 = 0.15 m/s
   right_speed = 7.8125 Ã— 0.032 = 0.25 m/s

4. å‘å¸ƒåˆ° /wheel_speed_cmd
   data = [0.15, 0.25]

5. USBèŠ‚ç‚¹æ‰“åŒ…å‘é€
   MSG_ID = 0x10
   left_wheel_speed_mps = 0.15 (float32)
   right_wheel_speed_mps = 0.25 (float32)

6. STM32 æ‰§è¡Œæ§åˆ¶

7. STM32 åé¦ˆ
   left_speed_mps = 0.15, left_angle_deg = 360.0
   right_speed_mps = 0.25, right_angle_deg = 720.0

8. USBèŠ‚ç‚¹è§£æ
   position = [6.283 rad, 12.566 rad]
   velocity = [4.6875 rad/s, 7.8125 rad/s]

9. å‘å¸ƒåˆ° /joint_states

10. ç¡¬ä»¶æ¥å£ read()
    hw_positions_ = [6.283, 12.566]
    hw_velocities_ = [4.6875, 7.8125]

11. diff_drive_controller è®¡ç®—é‡Œç¨‹è®¡
    å‘å¸ƒ /odom å’Œ /tf
```

---

## ğŸ“ æ¶æ„è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™
- **diff_drive_controller**: è´Ÿè´£å·®é€Ÿè¿åŠ¨å­¦ï¼ˆæ­£è§£å’Œé€†è§£ï¼‰ã€é‡Œç¨‹è®¡è®¡ç®—
- **ç¡¬ä»¶æ¥å£**: è´Ÿè´£å•ä½è½¬æ¢ï¼ˆrad/s â†” m/sï¼‰ã€ROS æ¥å£
- **USBèŠ‚ç‚¹**: è´Ÿè´£åè®®è½¬æ¢ï¼ˆROS æ¶ˆæ¯ â†” ä¸²å£å¸§ï¼‰ã€é€šè®¯ç®¡ç†
- **STM32**: è´Ÿè´£åº•å±‚æ§åˆ¶ï¼ˆç”µæœºã€ä¼ æ„Ÿå™¨ï¼‰

### 2. é¿å…é‡å¤è®¡ç®—
- å·®é€Ÿè¿åŠ¨å­¦åªåœ¨ diff_drive_controller è®¡ç®—ä¸€æ¬¡
- å•ä½è½¬æ¢éµå¾ªæœ€å°‘è½¬æ¢åŸåˆ™

### 3. æ˜ç¡®çš„æ¥å£å¥‘çº¦
- `/cmd_vel`: Twist æ¶ˆæ¯ï¼Œæœºå™¨äººæ•´ä½“é€Ÿåº¦
- `/wheel_speed_cmd`: Float32MultiArrayï¼Œå„è½®å­çº¿é€Ÿåº¦ï¼ˆm/sï¼‰
- `/joint_states`: JointStateï¼Œå…³èŠ‚çŠ¶æ€ï¼ˆä½ç½® radï¼Œé€Ÿåº¦ rad/sï¼‰

### 4. é…ç½®ä¸€è‡´æ€§
- æ‰€æœ‰é…ç½®æ–‡ä»¶ä½¿ç”¨ç›¸åŒçš„ç‰©ç†å‚æ•°
- é€šè¿‡ xacro å‚æ•°ä¼ é€’ï¼Œé¿å…ç¡¬ç¼–ç ï¼ˆæœªæ¥æ”¹è¿›ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **æ§åˆ¶æ¶æ„è¯´æ˜.md** - å®Œæ•´çš„æ¶æ„æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—
2. **STM32 ç«¯ USB é€šè®¯åè®®å®ç°ä»»åŠ¡æ–‡æ¡£.md** - é€šè®¯åè®®è¯¦ç»†è§„èŒƒ
3. **æµ‹è¯•æ§åˆ¶æµç¨‹.sh** - è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. æµ‹è¯•çœŸå®ç¡¬ä»¶
```bash
# å¯åŠ¨ç³»ç»Ÿ
cd /home/xiaoming/æ¡Œé¢/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot.launch.py

# å‘é€æµ‹è¯•å‘½ä»¤
ros2 topic pub /cmd_vel geometry_msgs/msg/Twist \
  "{linear: {x: 0.1}, angular: {z: 0.0}}" --once

# ç›‘æ§çŠ¶æ€
ros2 topic echo /joint_states
ros2 topic echo /odom
ros2 topic echo /usb_connected
```

### 2. è°ƒè¯•æŠ€å·§
```bash
# æŸ¥çœ‹è¯é¢˜åˆ—è¡¨
ros2 topic list

# æŸ¥çœ‹æ•°æ®æµ
ros2 topic echo /wheel_speed_cmd
ros2 topic echo /joint_states

# æŸ¥çœ‹æ§åˆ¶å™¨çŠ¶æ€
ros2 control list_controllers

# æŸ¥çœ‹é€šè®¯è´¨é‡
ros2 topic echo /comm_quality
```

### 3. æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
- è€ƒè™‘ä½¿ç”¨ xacro å‚æ•°ç»Ÿä¸€ç®¡ç†è½®å­å‚æ•°
- æ·»åŠ é€Ÿåº¦æ»¤æ³¢å™¨å¹³æ»‘å‘½ä»¤
- å®ç°è‡ªé€‚åº”è½®å­åŠå¾„æ ¡å‡†

---

## âœ… ä¿®å¤æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›
1. âœ… æ¶ˆé™¤å¾ªç¯ä¾èµ–ï¼šå¼•å…¥ä¸“ç”¨è¯é¢˜ `/wheel_speed_cmd`
2. âœ… æ˜ç¡®èŒè´£åˆ†å·¥ï¼šæ¯ä¸ªæ¨¡å—åªåšè‡ªå·±è¯¥åšçš„äº‹
3. âœ… æ­£ç¡®å•ä½è½¬æ¢ï¼šç»Ÿä¸€ä½¿ç”¨ç‰©ç†å•ä½ï¼ˆm/s, rad, rad/sï¼‰
4. âœ… é…ç½®ä¸€è‡´æ€§ï¼šæ‰€æœ‰é…ç½®æ–‡ä»¶å‚æ•°å¯¹é½

### éªŒè¯çŠ¶æ€
- âœ… ä»£ç ä¿®æ”¹å®Œæˆ
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… é…ç½®éªŒè¯é€šè¿‡
- âœ… é€»è¾‘æµ‹è¯•é€šè¿‡
- â³ ç¡¬ä»¶æµ‹è¯•å¾…è¿›è¡Œ

### æ–‡æ¡£å®Œæ•´æ€§
- âœ… æ§åˆ¶æ¶æ„è¯´æ˜æ–‡æ¡£
- âœ… ä¿®å¤æŠ¥å‘Šæ–‡æ¡£
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- âœ… ä»£ç æ³¨é‡Šå®Œå–„

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰

ç³»ç»Ÿç°åœ¨å…·æœ‰æ¸…æ™°ã€æ­£ç¡®çš„æ§åˆ¶æ¶æ„ï¼Œå¯ä»¥è¿›è¡ŒçœŸå®ç¡¬ä»¶æµ‹è¯•ã€‚

