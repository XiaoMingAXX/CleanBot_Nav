# 测试自动全屋覆盖路径规划

## 快速测试指南

### 1. 确保编译成功

```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
colcon build --packages-select cleanbot_navigation
```

### 2. 配置使用AutoCoveragePlanner

编辑配置文件: `src/cleanbot_navigation/config/nav2_sim_params.yaml`

找到`planner_server`部分,确保在清扫模式下使用AutoCoveragePlanner:

```yaml
planner_server:
  ros__parameters:
    planners:
      - EdgePlanner
      - BoustrophedonPlanner
      - AutoCoveragePlanner    # 自动全屋覆盖规划器
    
    EdgePlanner:
      plugin: "cleanbot_navigation::EdgePlanner"
      # ... 其他参数
    
    BoustrophedonPlanner:
      plugin: "cleanbot_navigation::BoustrophedonPlanner"
      # ... 其他参数
    
    AutoCoveragePlanner:
      plugin: "cleanbot_navigation::AutoCoveragePlanner"
      robot_radius: 0.15
      boundary_margin: 0.35
      waypoint_spacing: 0.5
      
      # 蚁群算法参数
      num_ants: 20
      max_iterations: 100
      
      # 覆盖参数
      coverage_stripe_width: 0.25    # 机器人直径0.3m,留0.05m重叠
```

### 3. 启动仿真环境

```bash
# Terminal 1: 启动导航系统
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_navigation navigation_sim.launch.py
```

### 4. 通过Web界面测试

```bash
# 打开浏览器访问
http://localhost:8000

# 步骤:
1. 等待地图加载完成
2. 点击"自动全屋"按钮
3. 在地图上点击一个起始目标点(可以是任意位置)
4. 观察路径规划过程
```

### 5. 观察日志输出

在Terminal 1中会看到详细的规划过程:

```
========== 开始自动全屋覆盖路径规划 ==========
[1/5] 地图预处理: 提取多边形边界和障碍物...
✓ 提取到外边界: XX个顶点, 障碍物: XX个

[2/5] 执行Cell Decomposition分块算法...
✓ 分解完成: 共XX个子区域

[3/5] 为每个子区域生成弓形覆盖路径...
✓ 所有子区域路径生成完成

[4/5] 使用蚁群算法求解TSP,优化子区域访问顺序...
✓ TSP求解完成, 最优访问顺序: [...]

[5/5] 连接所有子路径生成完整覆盖路径...
========== 自动全屋覆盖路径规划完成 ==========
✓ 总航点数: XXXX
✓ 覆盖子区域数: XX
✓ 总路径长度: XX.XXm
```

### 6. 在RViz中可视化

如果启动了RViz,可以观察到:

- **绿色路径**: 规划的完整覆盖路径
- **红色线段**: 当前执行的局部路径
- **蓝色区域**: Costmap
- **黄色箭头**: 机器人姿态

### 7. 验证覆盖效果

检查以下方面:

1. **路径是否覆盖整个地图?**
   - 观察路径是否遍历了所有可达区域
   - 是否避开了障碍物

2. **路径是否优化?**
   - 子区域访问顺序是否合理
   - 是否减少了不必要的往返

3. **路径是否可跟踪?**
   - 机器人能否顺利跟踪路径
   - 转角是否过于尖锐

4. **覆盖是否完整?**
   - 是否有遗漏区域
   - 条带之间是否有适当重叠

## 调试技巧

### 如果路径规划失败

1. **检查地图质量**
   ```bash
   # 查看日志中的地图预处理信息
   # 确认找到了有效边界
   ```

2. **调整边界余量**
   ```yaml
   boundary_margin: 0.5  # 增大余量,远离障碍物
   ```

3. **调整覆盖条带宽度**
   ```yaml
   coverage_stripe_width: 0.3  # 增大条带宽度,减少路径点
   ```

### 如果路径太长或太密集

1. **增加航点间距**
   ```yaml
   waypoint_spacing: 1.0  # 增大间距
   ```

2. **调整覆盖采样**
   - 修改`generateCellCoveragePath`中的采样间隔
   - 当前: `resolution * 2`
   - 可改为: `resolution * 3` 或 `resolution * 5`

### 如果TSP求解不够优化

1. **增加蚂蚁数量**
   ```yaml
   num_ants: 30
   ```

2. **增加迭代次数**
   ```yaml
   max_iterations: 200
   ```

3. **调整参数**
   ```yaml
   alpha: 1.0   # 信息素重要性
   beta: 5.0    # 距离启发信息重要性
   rho: 0.5     # 信息素挥发系数
   ```

## 性能测试

### 测试不同大小的地图

1. **小地图** (5m × 5m)
   - 预期规划时间: <5s
   - 预期Cell数量: 2-3个

2. **中等地图** (10m × 10m)
   - 预期规划时间: 5-10s
   - 预期Cell数量: 4-6个

3. **大地图** (20m × 20m)
   - 预期规划时间: 10-20s
   - 预期Cell数量: 8-12个

### 测试复杂环境

1. **无障碍物**: 应该生成简单的弓形路径
2. **少量障碍物**: 应该合理分块避开
3. **多个房间**: 应该优化房间访问顺序

## 与其他规划器对比

### EdgePlanner (沿边清扫)
- 只沿边界行走
- 不覆盖内部区域
- 路径简单但覆盖不完整

### BoustrophedonPlanner (简单弓形)
- 整个地图作为一个区域
- 不优化子区域顺序
- 可能产生很长的转角连接

### AutoCoveragePlanner (自动全屋) ✓
- 完整覆盖
- 优化访问顺序
- 自适应分块
- **推荐用于全屋清扫任务**

## 常见问题

### Q: 为什么路径没有闭合?
A: 自动全屋清扫不需要返回起点,完成最后一个Cell即可。

### Q: 为什么有些区域重复经过?
A: 这是Cell之间的连接路径,为了到达下一个子区域的入口。

### Q: 能否指定覆盖方向?
A: 当前算法自动选择最优方向。可以修改`coverage_direction`参数强制指定。

### Q: 为什么规划时间较长?
A: 蚁群算法需要多次迭代优化。可以减少`num_ants`或`max_iterations`来加速。

### Q: 机器人为什么不跟踪路径?
A: 检查DWB控制器参数,确保路径在机器人运动学能力范围内。

## 下一步

1. **实机测试**: 在真实机器人上测试
2. **参数优化**: 根据实际效果调整参数
3. **算法改进**: 实现完整的Boustrophedon分解
4. **多方向评估**: 选择最优覆盖方向

---

**测试愉快! 🤖**

