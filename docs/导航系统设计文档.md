# CleanBot 导航系统设计文档

## 1. 系统概述

本导航系统为双轮差速扫地机器人提供完整的SLAM建图和自主导航解决方案。系统采用模块化设计，支持手动控制、实时建图和自主导航三种工作模式的无缝切换。

### 1.1 设计目标

- **易用性**：Web界面一键式模式切换，无需命令行操作
- **可靠性**：生命周期节点管理，状态可控可追踪
- **实时性**：支持在线SLAM和实时导航
- **扩展性**：模块化架构，便于功能扩展

### 1.2 技术栈

- **ROS 2 Humble**：机器人操作系统
- **SLAM Toolbox**：图优化SLAM算法
- **Nav2**：导航框架
- **AMCL**：自适应蒙特卡洛定位
- **WebSocket**：Web前端通信
- **Python/C++**：节点实现语言

## 2. 系统架构

### 2.1 整体架构图

```
┌──────────────────────────────────────────────────────────────────┐
│                         应用层 (Application Layer)                │
├──────────────────────────────────────────────────────────────────┤
│  Web控制界面                                                       │
│  - 模式选择面板（手动/建图/导航）                                  │
│  - 摇杆控制                                                        │
│  - 地图保存按钮                                                    │
│  - 状态监控                                                        │
└───────────────────────────┬──────────────────────────────────────┘
                            │ WebSocket (JSON)
┌───────────────────────────┴──────────────────────────────────────┐
│                    控制层 (Control Layer)                         │
├──────────────────────────────────────────────────────────────────┤
│  web_control_node (Python)                                        │
│  - WebSocket服务器                                                │
│  - 消息格式转换 (JSON ↔ ROS Msg)                                 │
│  - 命令分发                                                        │
├──────────────────────────────────────────────────────────────────┤
│  navigation_mode_manager (Python)                                 │
│  - 模式状态机                                                      │
│  - 生命周期管理                                                    │
│  - 地图保存服务                                                    │
│  - 初始位姿发布                                                    │
└─────┬──────────────┬──────────────┬──────────────┬──────────────┘
      │              │              │              │
┌─────┴────┐  ┌──────┴──────┐  ┌───┴──────┐  ┌───┴──────────┐
│ 手动模式 │  │  建图模式   │  │ 导航模式 │  │  共享传感器  │
└─────┬────┘  └──────┬──────┘  └───┬──────┘  └───┬──────────┘
      │              │              │              │
┌─────┴────────────────────────────────────────────┴──────────────┐
│                    算法层 (Algorithm Layer)                       │
├──────────────────────────────────────────────────────────────────┤
│  SLAM Toolbox          AMCL              Nav2 Stack              │
│  - 图优化SLAM          - 粒子滤波        - 全局规划器            │
│  - 闭环检测            - 定位            - 局部规划器            │
│  - 地图构建            - 重定位          - 行为树                │
│                                          - 恢复行为              │
└─────────────────────────────┬────────────────────────────────────┘
                              │
┌─────────────────────────────┴────────────────────────────────────┐
│                    感知层 (Perception Layer)                      │
├──────────────────────────────────────────────────────────────────┤
│  RPLidar A1            EKF Fusion           TF Tree              │
│  - 360°激光扫描        - 多传感器融合       - 坐标变换           │
│  - /scan话题           - /odometry/filtered  - map↔odom↔base     │
└─────────────────────────────┬────────────────────────────────────┘
                              │
┌─────────────────────────────┴────────────────────────────────────┐
│                    执行层 (Execution Layer)                       │
├──────────────────────────────────────────────────────────────────┤
│  ros2_control              Diff Drive Controller                 │
│  - 硬件抽象              - 差速运动学                             │
│  - 速度命令转轮速        - 里程计计算                             │
│                                                                   │
│  USB Communication Node                                           │
│  - STM32通讯协议                                                  │
│  - IMU数据接收                                                    │
│  - 轮速命令发送                                                    │
└───────────────────────────────────────────────────────────────────┘
```

### 2.2 模式状态机

```
                    ┌─────────────┐
                    │  系统启动   │
                    └──────┬──────┘
                           │
                           v
               ┌───────────────────────┐
               │   手动模式 (默认)     │◄────┐
               │  - 摇杆控制启用       │     │
               │  - SLAM/Nav2停用      │     │
               └───┬───────────┬───────┘     │
                   │           │             │
        切换到建图  │           │  切换到导航 │
                   v           v             │
          ┌────────────┐  ┌────────────┐    │
          │  建图模式  │  │  导航模式  │    │
          │ - SLAM激活 │  │ - AMCL激活 │    │
          │ - 摇杆启用 │  │ - Nav2激活 │    │
          │ - 可保存图 │  │ - 摇杆禁用 │    │
          └─────┬──────┘  └─────┬──────┘    │
                │               │            │
                └───────┬───────┘            │
                        │ 切换到手动          │
                        └────────────────────┘
```

### 2.3 数据流图

```
激光雷达 ─────► /scan ─────┬─────► SLAM Toolbox ─────► /map
                           │
                           └─────► AMCL ─────────────► /amcl_pose
                           │
                           └─────► Costmap ──────────► 障碍物检测

IMU ──────────┐
               ├────► EKF ─────► /odometry/filtered ───┬──► SLAM
轮速编码器 ────┘                                        │
                                                       ├──► AMCL
                                                       │
                                                       └──► 里程计位置

用户目标 ─────► Web界面 ─────► /goal_pose ─────► Nav2 ─────► /cmd_vel
                                                        │
                                                        v
Web界面 ◄────── 机器人状态 ◄────── WebSocket ◄─── ros2_control
```

## 3. 核心模块设计

### 3.1 navigation_mode_manager节点

**职责**：导航模式管理和生命周期控制

**主要功能**：
1. 接收模式切换命令（`/navigation/mode_cmd`）
2. 管理SLAM/AMCL/MapServer的生命周期状态
3. 发布当前模式状态（`/navigation/mode_status`）
4. 提供地图保存服务（`/navigation/save_map`）
5. 自动发布初始位姿到AMCL

**关键类和方法**：
```python
class NavigationModeManager(Node):
    # 模式常量
    MODE_MANUAL = 0
    MODE_MAPPING = 1
    MODE_NAVIGATION = 2
    
    def switch_mode(self, new_mode: int):
        """模式切换主逻辑"""
        # 1. 停用旧模式节点
        # 2. 激活新模式节点
        # 3. 发布状态更新
        
    def activate_slam(self):
        """激活SLAM节点"""
        # configure -> activate
        
    def activate_navigation(self):
        """激活导航节点"""
        # 1. 激活Map Server
        # 2. 激活AMCL
        # 3. 发布初始位姿
        
    def publish_initial_pose(self):
        """发布初始位姿到AMCL"""
        # 使用当前里程计位置作为初始估计
```

**状态转换流程**：
```
Unconfigured ──configure──► Inactive ──activate──► Active
     ▲                          │                    │
     │                          │                    │
     └────────cleanup◄──────deactivate◄─────────────┘
```

### 3.2 SLAM配置（slam_toolbox）

**算法选择**：异步SLAM（Async SLAM Toolbox）
- 优点：适合在线实时建图，计算效率高
- 缺点：相比同步SLAM精度略低（对扫地机器人足够）

**关键参数**：

| 参数 | 值 | 说明 |
|------|-----|------|
| resolution | 0.05 | 地图分辨率(m/pixel) |
| minimum_travel_distance | 0.2 | 最小移动距离触发更新(m) |
| minimum_travel_heading | 0.2 | 最小旋转角度触发更新(rad) |
| loop_search_maximum_distance | 3.0 | 闭环搜索最大距离(m) |
| do_loop_closing | true | 启用闭环检测 |
| scan_buffer_size | 10 | 扫描缓冲区大小 |

**闭环检测机制**：
1. 机器人移动到之前访问过的区域
2. 检测到相似的激光扫描特征
3. 触发图优化，修正累积误差
4. 更新地图和机器人轨迹

### 3.3 定位配置（AMCL）

**算法原理**：粒子滤波（Particle Filter）
- 维护多个位姿假设（粒子）
- 通过激光扫描匹配更新权重
- 重采样保留高概率粒子

**关键参数**：

| 参数 | 值 | 说明 |
|------|-----|------|
| min_particles | 500 | 最少粒子数 |
| max_particles | 2000 | 最多粒子数 |
| update_min_d | 0.15 | 最小移动距离更新(m) |
| update_min_a | 0.2 | 最小旋转角度更新(rad) |
| laser_max_range | 12.0 | 激光最大有效距离(m) |
| laser_z_hit | 0.5 | 似然场权重 |

**初始位姿策略**：
- 建图和导航时假设起点大致相同
- 系统自动使用当前里程计位置作为初始位姿
- 协方差设置：xy=0.25m², θ=0.06854rad²

### 3.4 导航配置（Nav2）

**架构组件**：

1. **全局规划器**（Planner Server）
   - 算法：Navfn（Dijkstra变体）
   - 输入：起点、终点、静态地图
   - 输出：全局路径

2. **局部规划器**（Controller Server）
   - 算法：DWB（Dynamic Window Approach）
   - 输入：全局路径、局部代价地图、机器人状态
   - 输出：速度命令
   - 特点：考虑动力学约束，支持动态避障

3. **代价地图**（Costmap）
   - 全局代价地图：基于静态地图
   - 局部代价地图：实时更新障碍物
   - 膨胀层：障碍物周围安全距离

4. **行为树**（Behavior Tree）
   - 任务协调和决策
   - 失败恢复策略
   - 可自定义行为

**DWB控制器参数**：

| 参数 | 值 | 说明 |
|------|-----|------|
| max_vel_x | 0.3 | 最大线速度(m/s) |
| max_vel_theta | 1.0 | 最大角速度(rad/s) |
| acc_lim_x | 0.5 | 线加速度限制(m/s²) |
| acc_lim_theta | 1.5 | 角加速度限制(rad/s²) |
| sim_time | 1.5 | 轨迹模拟时间(s) |
| vx_samples | 20 | 线速度采样数 |
| vtheta_samples | 20 | 角速度采样数 |

**代价地图配置**：

| 参数 | 值 | 说明 |
|------|-----|------|
| robot_radius | 0.15 | 机器人半径(m) |
| inflation_radius | 0.3 | 膨胀半径(m) |
| obstacle_max_range | 2.5 | 障碍物检测最大距离(m) |
| raytrace_max_range | 3.0 | 光线追踪最大距离(m) |

### 3.5 Web前端集成

**消息类型扩展**：

```javascript
// 发送：模式切换命令
{
    type: 'navigation_mode',
    mode: 0/1/2  // 手动/建图/导航
}

// 发送：保存地图请求
{
    type: 'save_map'
}

// 接收：导航信息
{
    type: 'navigation_info',
    message: 'mode_changed:mapping'
}
```

**UI控制逻辑**：
1. 导航模式为"导航"时，禁用摇杆（`joystickEnabled = false`）
2. 导航模式为"建图"时，启用"保存地图"按钮
3. 实时显示当前模式状态

## 4. 通信接口

### 4.1 话题列表

| 话题名称 | 消息类型 | 方向 | 说明 |
|---------|---------|------|------|
| /scan | sensor_msgs/LaserScan | 订阅 | 激光雷达数据 |
| /odometry/filtered | nav_msgs/Odometry | 订阅 | 融合里程计 |
| /map | nav_msgs/OccupancyGrid | 发布 | 地图数据 |
| /navigation/mode_cmd | std_msgs/UInt8 | 订阅 | 模式切换命令 |
| /navigation/mode_status | std_msgs/UInt8 | 发布 | 当前模式状态 |
| /navigation/info | std_msgs/String | 发布 | 导航信息 |
| /initialpose | geometry_msgs/PoseWithCovarianceStamped | 发布 | AMCL初始位姿 |
| /goal_pose | geometry_msgs/PoseStamped | 订阅 | 导航目标 |
| /cmd_vel | geometry_msgs/TwistStamped | 发布 | 速度命令 |

### 4.2 服务列表

| 服务名称 | 服务类型 | 说明 |
|---------|---------|------|
| /navigation/save_map | std_srvs/Empty | 保存当前地图 |
| /slam_toolbox/change_state | lifecycle_msgs/ChangeState | SLAM生命周期控制 |
| /amcl/change_state | lifecycle_msgs/ChangeState | AMCL生命周期控制 |
| /map_server/change_state | lifecycle_msgs/ChangeState | MapServer生命周期控制 |

### 4.3 坐标系变换（TF Tree）

```
map
 └─ odom
     └─ base_footprint
         ├─ base_link
         │   ├─ imu_link
         │   ├─ laser (RPLidar)
         │   ├─ left_wheel_link
         │   └─ right_wheel_link
         └─ caster_link
```

**坐标系说明**：
- `map`: 全局地图坐标系（固定）
- `odom`: 里程计坐标系（连续但可能漂移）
- `base_footprint`: 机器人在地面的投影
- `base_link`: 机器人中心
- `map→odom`: 由SLAM或AMCL提供，修正里程计漂移

## 5. 实现细节

### 5.1 生命周期管理实现

```python
def change_state(self, client, transition_id):
    """改变节点生命周期状态"""
    request = ChangeState.Request()
    request.transition.id = transition_id
    
    future = client.call_async(request)
    rclpy.spin_until_future_complete(self, future, timeout_sec=5.0)
    
    if future.result() and future.result().success:
        return True
    return False

# 使用示例
self.change_state(self.slam_change_state_client, 
                  Transition.TRANSITION_CONFIGURE)
self.change_state(self.slam_change_state_client, 
                  Transition.TRANSITION_ACTIVATE)
```

### 5.2 地图保存实现

```python
def save_map_callback(self, request, response):
    """保存地图服务回调"""
    # 生成带时间戳的地图文件名
    timestamp = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
    map_name = f'cleanbot_map_{timestamp}'
    map_path = os.path.join(self.map_save_dir, map_name)
    
    # 调用nav2_map_server的map_saver_cli
    cmd = [
        'ros2', 'run', 'nav2_map_server', 'map_saver_cli',
        '-f', map_path,
        '--ros-args', '-p', 'save_map_timeout:=5000'
    ]
    
    result = subprocess.run(cmd, capture_output=True, timeout=10)
    
    if result.returncode == 0:
        self.get_logger().info(f'✅ 地图保存成功: {map_path}')
        # 通知前端
        self.info_pub.publish(String(data=f'map_saved:{map_name}'))
    
    return response
```

### 5.3 初始位姿发布实现

```python
def publish_initial_pose(self):
    """发布初始位姿到AMCL"""
    pose_msg = PoseWithCovarianceStamped()
    pose_msg.header.stamp = self.get_clock().now().to_msg()
    pose_msg.header.frame_id = 'map'
    
    if self.last_odom is not None:
        # 使用当前里程计位置
        pose_msg.pose.pose = self.last_odom.pose.pose
    else:
        # 使用原点
        pose_msg.pose.pose.position.x = 0.0
        pose_msg.pose.pose.position.y = 0.0
        pose_msg.pose.pose.orientation.w = 1.0
    
    # 设置协方差（初始不确定性）
    pose_msg.pose.covariance = [
        0.25, 0.0, 0.0, 0.0, 0.0, 0.0,  # x: ±0.5m
        0.0, 0.25, 0.0, 0.0, 0.0, 0.0,  # y: ±0.5m
        0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 0.06854  # θ: ±15°
    ]
    
    # 发布多次确保接收
    for _ in range(3):
        self.initialpose_pub.publish(pose_msg)
        time.sleep(0.1)
```

## 6. 性能优化

### 6.1 计算性能优化

1. **SLAM优化**
   - 使用`throttle_scans: 1`处理所有帧（实时性）
   - 小场景使用Ceres优化器（精度）
   - 大场景使用SparseLevenbergMarquardt（速度）

2. **AMCL优化**
   - 动态粒子数调整（500-2000）
   - 适当增大更新阈值减少计算频率
   - 使用likelihood_field模型（比beam模型快）

3. **Nav2优化**
   - 局部代价地图使用滚动窗口（3m×3m）
   - 全局规划器频率降低（1Hz）
   - 速度平滑器减少抖动

### 6.2 通信性能优化

1. **话题QoS配置**
   ```python
   # 可靠通信
   qos_reliable = QoSProfile(
       reliability=QoSReliabilityPolicy.RELIABLE,
       durability=QoSDurabilityPolicy.VOLATILE,
       depth=10
   )
   
   # 传感器数据（允许丢失）
   qos_sensor = QoSProfile(
       reliability=QoSReliabilityPolicy.BEST_EFFORT,
       durability=QoSDurabilityPolicy.VOLATILE,
       depth=5
   )
   ```

2. **WebSocket优化**
   - 状态更新频率：10Hz
   - JSON压缩传输
   - 断线自动重连

### 6.3 内存优化

- 地图分辨率权衡（0.05m vs 0.1m）
- 粒子数量上限设置
- 代价地图大小限制
- 路径平滑减少存储点数

## 7. 安全机制

### 7.1 紧急停止

- Web界面紧急停止按钮
- 碰撞传感器触发自动停止
- 通信超时自动停止（watchdog）

### 7.2 障碍物避障

- 静态障碍物：地图膨胀层
- 动态障碍物：实时局部代价地图更新
- 安全距离：robot_radius + inflation_radius = 0.45m

### 7.3 失败恢复

Nav2内置恢复行为：
1. **清除代价地图**：清除局部障碍物信息
2. **原地旋转**：寻找可行路径
3. **后退**：脱离困境
4. **等待**：等待动态障碍物移动

### 7.4 模式切换保护

- 切换前停止机器人运动
- 渐进式激活节点（configure → activate）
- 状态检查和超时处理
- 失败时回退到手动模式

## 8. 测试和验证

### 8.1 单元测试

```python
# 测试模式切换
def test_mode_switching():
    assert current_mode == MODE_MANUAL
    switch_to_mapping()
    assert current_mode == MODE_MAPPING
    assert slam_node_active == True

# 测试地图保存
def test_map_saving():
    result = save_map()
    assert os.path.exists(map_file)
```

### 8.2 集成测试

1. **建图测试**
   - 手动驾驶完整环境
   - 检查地图质量
   - 验证闭环检测

2. **定位测试**
   - 加载已保存地图
   - 检查定位收敛时间
   - 验证定位精度

3. **导航测试**
   - 设置多个目标点
   - 检查路径规划合理性
   - 验证避障效果

### 8.3 性能测试

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| SLAM更新频率 | >0.5Hz | `ros2 topic hz /map` |
| AMCL定位频率 | >10Hz | `ros2 topic hz /amcl_pose` |
| 控制延迟 | <100ms | 时间戳对比 |
| CPU使用率 | <60% | `top` |
| 内存使用 | <2GB | `free -h` |

## 9. 未来扩展

### 9.1 多楼层支持

- 电梯识别和跨楼层导航
- 多地图管理和切换
- 楼层标识符

### 9.2 语义地图

- 房间分割和标注
- 清扫区域划分
- 禁区设置

### 9.3 智能任务规划

- 全覆盖路径规划
- 多目标点优化排序
- 电量管理和自动回充

### 9.4 云端集成

- 地图云端存储
- 远程监控和控制
- 数据分析和优化

## 10. 参考资料

### 10.1 算法论文

1. Konolige, K., Grisetti, G., et al. (2010). "Efficient Sparse Pose Adjustment for 2D mapping"
2. Fox, D., et al. (2003). "Adapting the Sample Size in Particle Filters Through KLD-Sampling"
3. Fox, D., et al. (1997). "The Dynamic Window Approach to Collision Avoidance"

### 10.2 开源项目

- [slam_toolbox](https://github.com/SteveMacenski/slam_toolbox)
- [navigation2](https://github.com/ros-planning/navigation2)
- [rplidar_ros](https://github.com/Slamtec/rplidar_ros)

### 10.3 官方文档

- [Nav2 Documentation](https://navigation.ros.org/)
- [ROS 2 Design](https://design.ros2.org/)
- [Lifecycle Nodes](https://design.ros2.org/articles/node_lifecycle.html)

---

**文档版本**：v1.0  
**最后更新**：2025-12-14  
**维护者**：CleanBot Team











