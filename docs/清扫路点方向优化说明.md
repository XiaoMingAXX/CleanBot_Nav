# 清扫路点方向优化说明

## 问题描述

原先的实现中，路点的方向是指向**下一个目标点**，这导致：
- 机器人到达每个路点后需要旋转调整方向
- 运动不连续，频繁停顿和转向
- 清扫效率降低

## 优化方案

**新策略**：每个路点的方向指向**从上一个路点到当前路点的方向**

### 优势
1. ✅ 机器人在运动过程中已经保持正确朝向
2. ✅ 到达路点时无需额外旋转
3. ✅ 运动连续流畅
4. ✅ 提高清扫效率

## 实现细节

### 1. 沿边清扫模式 (EDGE)

**修改前**：
```python
# 路点方向 = 从当前点指向下一个边界点
yaw = math.atan2(next_y - curr_y, next_x - curr_x)
```

**修改后**：
```python
# 路点方向 = 从上一个点指向当前点
dx_to_curr = curr_x - prev_x
dy_to_curr = curr_y - prev_y
yaw = math.atan2(dy_to_curr, dx_to_curr)
```

**逻辑**：
- 边界点的方向：从前一个边界点指向当前边界点
- 插值点的方向：从当前边界点指向下一个边界点（插值点之间的运动方向）

### 2. 弓形清扫模式 (BOUSTROPHEDON)

**修改前**：
```python
# 指向下一个点（除了最后一个点）
if i < len(line_points) - 1:
    yaw = math.atan2(line_points[i+1][1] - py, line_points[i+1][0] - px)
elif i > 0:
    yaw = math.atan2(py - line_points[i-1][1], px - line_points[i-1][0])
```

**修改后**：
```python
# 始终从上一个点指向当前点
if i > 0:
    # 同一扫描线内：从前一个点指向当前点
    yaw = math.atan2(py - line_points[i-1][1], px - line_points[i-1][0])
elif len(waypoints) > 0:
    # 扫描线第一个点：从上一条线的最后一个点指向当前点
    prev_pose = waypoints[-1]
    yaw = math.atan2(py - prev_pose.pose.position.y, 
                     px - prev_pose.pose.position.x)
else:
    # 全局第一个点：使用默认扫描方向
    yaw = 0.0 if direction == 1 else math.pi
```

**逻辑**：
- 扫描线内的点：从同一线上的前一个点指向当前点
- 扫描线首点：从上一条扫描线的末点指向当前点（实现平滑转弯）
- 全局首点：使用默认方向

### 3. 全屋覆盖清扫模式 (AUTO)

**修改前**：
```python
# 水平扫描：固定方向
yaw = 0.0 if direction == 1 else math.pi  # 0° 或 180°

# 垂直扫描：固定方向
yaw = math.pi / 2.0 if direction == 1 else -math.pi / 2.0  # 90° 或 -90°
```

**修改后**：
```python
# 动态计算方向（水平/垂直扫描相同逻辑）
if i > 0:
    # 从前一个点指向当前点
    yaw = math.atan2(py - line_points[i-1][1], px - line_points[i-1][0])
elif len(coverage_path) > 0:
    # 从前一个单元格的最后一个点指向当前点
    prev_pose = coverage_path[-1]
    yaw = math.atan2(py - prev_pose.pose.position.y,
                     px - prev_pose.pose.position.x)
else:
    # 第一个点使用默认扫描方向
    yaw = 0.0 if direction == 1 else math.pi  # 水平
    yaw = math.pi / 2.0 if direction == 1 else -math.pi / 2.0  # 垂直
```

**逻辑**：
- 单元格内的点：从前一个点指向当前点
- 单元格首点：从上一个单元格的末点指向当前点
- 全局首点：使用默认扫描方向

## 方向计算公式

所有方向都使用 `atan2` 函数计算，并转换为四元数：

```python
# 计算航向角
yaw = math.atan2(dy, dx)  # dy = y_curr - y_prev, dx = x_curr - x_prev

# 转换为四元数（简化版，仅绕z轴旋转）
orientation.z = math.sin(yaw / 2.0)
orientation.w = math.cos(yaw / 2.0)
```

## 测试建议

1. **观察运动连续性**：机器人应该平滑移动，无不必要的旋转
2. **检查转角处**：扫描线之间的转换应该自然
3. **验证清扫覆盖**：确保方向变化不影响清扫覆盖率
4. **测试边界情况**：
   - 第一个路点
   - 扫描线交界处
   - 闭环路径的首尾连接

## 修改文件

- `src/cleanbot_navigation/cleanbot_navigation/cleaning_task_node.py`
  - `_plan_edge_cleaning()` - 沿边清扫
  - `_plan_boustrophedon_cleaning()` - 弓形清扫
  - `_generate_cell_coverage_path()` - 全屋覆盖（水平+垂直）

## 预期效果

修改后的路径应该实现：
- ✅ 机器人始终朝向前进方向
- ✅ 运动轨迹平滑连续
- ✅ 减少不必要的旋转
- ✅ 提高清扫效率和用户体验

---
**修改日期**: 2026-01-06
**修改原因**: 优化路点方向策略，实现连续平滑的清扫运动

