# 语音控制节点使用说明

## 概述

语音控制节点（`voice_control_node.py`）实现了通过语音模块串口指令控制清扫机器人的功能。该节点解析语音模块发送的5字节串口帧，并将其转换为对应的ROS2控制命令。

## 功能特性

### 1. 运动控制

#### 遥控模式（速度控制）
- **慢速前进/后退**：设定的慢速线速度（默认0.15 m/s）
- **快速前进/后退**：设定的快速线速度（默认0.3 m/s）
- **慢速/快速左旋/右旋**：设定的角速度（慢速0.5 rad/s，快速1.0 rad/s）
- **慢速/快速左转/右转**：同时发布线速度和角速度

#### 里程模式（步进控制）
- **小步前进/后退**：固定距离移动（默认0.1 m）
- **大步前进/后退**：固定距离移动（默认0.5 m）
- **小步左旋/右旋**：固定角度旋转（默认10度）
- **大步左旋/右旋**：固定角度旋转（默认45度）
- **向后转**：180度旋转

### 2. 执行器控制

- **边刷控制**：打开（3档）/ 关闭（0档）
- **风机控制**：打开（3档）/ 强劲（5档）/ 关闭（0档）
- **水泵控制**：打开（3档）/ 强劲（5档）/ 关闭（0档）

### 3. 模式切换

- **手动模式**：允许手动控制机器人
- **建图模式**：启动SLAM建图
- **导航模式**：启动自主导航

### 4. 运动停止

- **运动停止**：立即停止机器人所有运动，发布零速度命令

### 5. 工作模式切换（清扫任务）

- **待机模式**：停止所有清扫任务，同时关闭所有执行器（边刷、吸尘、洗地）
- **自动全屋**：自动切换到导航模式并启动全屋覆盖清扫，同时启动强劲吸尘（5档）、强劲洗地（5档）、打开边刷（3档）
- **沿边模式**：自动切换到导航模式并启动沿边清扫，同时启动强劲吸尘（5档）、强劲洗地（5档）、打开边刷（3档）
- **弓形模式**：自动切换到导航模式并启动弓形清扫，同时启动强劲吸尘（5档）、强劲洗地（5档）、打开边刷（3档）

**注意**：全屋、沿边、弓形模式会自动切换到导航模式，启动对应的清扫算法，并自动以强劲模式开启所有执行器。

### 6. 特殊语音交互

- **地好脏**：启动全屋深度清扫模式（等同于自动全屋）
- **你好吵**：打开吸尘（3档）和洗地（3档）
- **你是谁**：机器人展示动作 - 先左转20度，3秒后右转20度回到原位

### 7. 基础功能

- 欢迎语、休息语、音量控制等语音反馈（仅记录日志，不影响控制）

## 串口协议

### 帧格式
所有指令遵循5字节固定帧格式：

| 字节位置 | 含义 | 固定值/说明 |
|---------|------|-----------|
| 第1字节 | 帧头1 | 0xAA（固定）|
| 第2字节 | 帧头2 | 0x55（固定）|
| 第3字节 | 指令子码 | 区分具体指令 |
| 第4字节 | 指令主码 | 区分功能大类 |
| 第5字节 | 帧尾 | 0xFB（固定）|

### 示例指令

```
慢速前进：AA 55 00 01 FB
快速前进：AA 55 00 02 FB
打开边刷：AA 55 00 15 FB
建图模式：AA 55 00 28 FB
导航模式：AA 55 00 29 FB
运动停止：AA 55 00 2B FB
待机模式：AA 55 00 30 FB
自动全屋：AA 55 00 31 FB
沿边模式：AA 55 00 32 FB
弓形模式：AA 55 00 33 FB
地好脏：  AA 55 00 34 FB
你好吵：  AA 55 00 35 FB
你是谁：  AA 55 00 36 FB
```

完整的指令表请参见用户提供的《语音模块指令 - 串口数据对应文档》。

## 配置参数

配置文件：`config/voice_control_params.yaml`

### 串口配置
```yaml
port: '/dev/ttyUSB0'       # 语音模块串口（需根据实际调整）
baudrate: 9600              # 波特率
auto_reconnect: true        # 自动重连
reconnect_interval: 2.0     # 重连间隔（秒）
```

### 速度控制参数（遥控模式）
```yaml
# 慢速档
slow_linear_speed: 0.15     # 慢速线速度 (m/s)
slow_angular_speed: 0.5     # 慢速角速度 (rad/s)
slow_turn_angular: 0.3      # 慢速转弯角速度 (rad/s)

# 快速档
fast_linear_speed: 0.3      # 快速线速度 (m/s)
fast_angular_speed: 1.0     # 快速角速度 (rad/s)
fast_turn_angular: 0.6      # 快速转弯角速度 (rad/s)
```

### 里程控制参数（步进模式）
```yaml
# 小步档
small_step_distance: 0.1    # 小步距离 (m)
small_step_angle: 0.174     # 小步角度 (rad, 约10度)

# 大步档
large_step_distance: 0.5    # 大步距离 (m)
large_step_angle: 0.785     # 大步角度 (rad, 约45度)

# 特殊动作
turn_around_angle: 3.14159  # 向后转角度 (rad, 180度)
```

## 使用方法

### 1. 硬件连接

1. 将语音模块通过USB转串口连接到机器人主机
2. 确认串口设备名称（通常是 `/dev/ttyUSB0` 或 `/dev/ttyUSB1`）
3. 确认串口权限：
   ```bash
   sudo chmod 666 /dev/ttyUSB0
   # 或者将用户添加到dialout组（需重新登录）
   sudo usermod -a -G dialout $USER
   ```

### 2. 修改配置（可选）

编辑配置文件调整串口和速度参数：
```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
nano src/cleanbot_control/config/voice_control_params.yaml
```

主要需要修改的参数：
- `port`: 根据实际串口设备修改
- 速度参数：根据实际机器人性能调整

### 3. 启动节点

#### 实机模式
语音控制节点已集成到实机启动文件中：
```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot.launch.py
```

#### 仿真模式
语音控制节点也已集成到仿真启动文件中：
```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot_gazebo.launch.py
```

#### 单独启动（调试用）
```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 run cleanbot_control voice_control_node.py --ros-args --params-file src/cleanbot_control/config/voice_control_params.yaml
```

### 4. 查看节点状态

检查节点是否正常运行：
```bash
ros2 node list | grep voice_control
```

查看节点日志：
```bash
ros2 node info /voice_control_node
```

查看实时日志：
```bash
ros2 topic echo /rosout | grep voice_control
```

## 话题接口

### 发布话题

| 话题名称 | 消息类型 | 功能 |
|---------|---------|------|
| `/manual_control_cmd` | `std_msgs/Float32MultiArray` | 手动控制命令（速度/里程） |
| `/control_command` | `std_msgs/UInt8MultiArray` | 执行器控制命令 |
| `/navigation/mode_cmd` | `std_msgs/UInt8` | 导航模式切换 |
| `/cleaning/mode_cmd` | `std_msgs/UInt8` | 清扫模式切换 |

### 数据格式

#### `/manual_control_cmd`
```
[control_mode, linear_vel, angular_vel, target_distance, target_yaw]

遥控模式 (control_mode=0):
  - linear_vel: 线速度 (m/s)
  - angular_vel: 角速度 (rad/s)
  - target_distance: 不使用 (0.0)
  - target_yaw: 不使用 (0.0)

里程模式 (control_mode=1):
  - linear_vel: 不使用 (0.0)
  - angular_vel: 不使用 (0.0)
  - target_distance: 目标距离增量 (m)
  - target_yaw: 目标航向增量 (rad)
```

#### `/control_command`
```
[work_mode, side_brush_left, side_brush_right, fan_level, water_level, need_ack]

各参数取值范围:
  - work_mode: 0-5（工作模式）
  - side_brush_left: 0-3（左边刷档位）
  - side_brush_right: 0-3（右边刷档位）
  - fan_level: 0-5（风机档位）
  - water_level: 0-5（水泵档位）
  - need_ack: 0/1（是否需要应答）
```

#### `/navigation/mode_cmd`
```
模式值:
  - 0: 手动模式
  - 1: 建图模式
  - 2: 导航模式
```

#### `/cleaning/mode_cmd`
```
清扫模式值:
  - 0: 待机（停止清扫）
  - 1: 沿边清扫
  - 2: 弓形清扫
  - 3: 全屋覆盖
```

## 调试与测试

### 1. 串口通讯测试

使用串口调试工具（如minicom）验证串口连接：
```bash
sudo apt install minicom
sudo minicom -D /dev/ttyUSB0 -b 9600
```

### 2. 手动发送测试帧

可以使用Python脚本手动发送测试帧：
```python
import serial
import time

ser = serial.Serial('/dev/ttyUSB0', 9600, timeout=1)

# 发送"慢速前进"指令: AA 55 00 01 FB
frame = bytes([0xAA, 0x55, 0x00, 0x01, 0xFB])
ser.write(frame)
time.sleep(0.5)

ser.close()
```

### 3. 监控ROS话题

监控手动控制命令：
```bash
ros2 topic echo /manual_control_cmd
```

监控执行器命令：
```bash
ros2 topic echo /control_command
```

监控导航模式：
```bash
ros2 topic echo /navigation/mode_cmd
```

监控清扫模式：
```bash
ros2 topic echo /cleaning/mode_cmd
```

## 注意事项

1. **串口权限**：确保用户有串口读写权限，否则节点无法连接串口
2. **串口冲突**：确保没有其他程序占用语音模块串口
3. **参数调整**：速度参数需根据实际机器人性能调整，避免超出硬件限制
4. **自动重连**：节点支持自动重连，串口断开后会自动尝试重连
5. **模式切换**：模式切换由前端控制，语音控制只发送模式切换命令
6. **执行器状态**：节点会记忆当前执行器状态，只修改语音指令涉及的执行器

## 故障排除

### 问题1：节点启动失败，提示"串口连接失败"

**原因**：串口设备不存在或权限不足

**解决方法**：
```bash
# 1. 检查串口是否存在
ls -l /dev/ttyUSB*

# 2. 添加串口权限
sudo chmod 666 /dev/ttyUSB0

# 或者将用户添加到dialout组
sudo usermod -a -G dialout $USER
# 注销后重新登录
```

### 问题2：接收不到语音指令

**原因**：串口参数配置错误或硬件连接问题

**解决方法**：
1. 确认语音模块波特率（默认9600）
2. 使用串口调试工具测试硬件连接
3. 检查串口线是否正常
4. 查看节点日志确认帧解析情况

### 问题3：机器人没有响应语音指令

**原因**：控制命令没有被正确处理

**解决方法**：
1. 检查手动控制节点是否正常运行
2. 确认导航模式正确（速度控制需在手动或建图模式）
3. 监控ROS话题确认命令已发布
4. 检查前端是否有冲突的控制命令

### 问题4：速度过快或过慢

**原因**：速度参数不适合当前机器人

**解决方法**：
调整配置文件中的速度参数：
```yaml
# 降低速度
slow_linear_speed: 0.1    # 原0.15
fast_linear_speed: 0.2    # 原0.3
```

## 与前端控制的关系

语音控制节点与前端Web控制**并行工作**，两者通过相同的ROS话题控制机器人：

- **手动控制**：语音和Web都通过 `/manual_control_cmd` 控制
- **执行器控制**：语音和Web都通过 `/control_command` 控制
- **模式切换**：语音和Web都通过 `/navigation/mode_cmd` 切换模式

**注意**：如果同时使用语音和Web控制，后发送的命令会覆盖前一个命令。建议在实际使用中选择一种控制方式，避免冲突。

## 未来扩展

可能的扩展方向：

1. **语音反馈**：增加TTS语音反馈，告知用户操作结果
2. **指令确认**：增加关键操作的确认机制
3. **组合指令**：支持连续多个动作的组合指令
4. **安全限制**：根据传感器状态限制危险操作
5. **状态查询**：支持查询机器人当前状态

## 技术支持

如有问题，请查看：
- 节点源码：`src/cleanbot_control/scripts/voice_control_node.py`
- 配置文件：`src/cleanbot_control/config/voice_control_params.yaml`
- 系统日志：`ros2 topic echo /rosout`

