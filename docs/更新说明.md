# CleanBot Control System - æ›´æ–°è¯´æ˜

## æ›´æ–°æ—¥æœŸï¼š2025-11-27

---

## ğŸ¨ é‡å¤§æ›´æ–°

### 1. Webç•Œé¢å…¨é¢å‡çº§ âœ…

#### æ–°è®¾è®¡ç‰¹ç‚¹
- **ç°ä»£ç§‘æŠ€æ„Ÿè®¾è®¡**
  - æ·±è‰²ä¸»é¢˜é…è‰²æ–¹æ¡ˆ
  - æ¸å˜è‰²è¾¹æ¡†å’Œå‘å…‰æ•ˆæœ
  - æµç•…çš„è¿‡æ¸¡åŠ¨ç”»
  - å“åº”å¼å¸ƒå±€

- **è§†è§‰æ•ˆæœå¢å¼º**
  - å¡ç‰‡æ‚¬åœæ•ˆæœ
  - æŒ‰é’®ç‚¹å‡»åé¦ˆ
  - åŠ¨æ€èƒŒæ™¯æ¸å˜
  - ä¼ æ„Ÿå™¨çŠ¶æ€é—ªçƒå‘Šè­¦

#### é…è‰²æ–¹æ¡ˆ
```
ä¸»è‰²è°ƒï¼šé’è“è‰² (#00d9ff)
è¾…åŠ©è‰²ï¼šç´«è‰² (#7b2cbf)
å¼ºè°ƒè‰²ï¼šç²‰çº¢ (#ff006e)
èƒŒæ™¯è‰²ï¼šæ·±è“é»‘ (#0a0e27)
æˆåŠŸè‰²ï¼šç¿ ç»¿ (#00ff88)
è­¦å‘Šè‰²ï¼šç¥ç€ (#ffaa00)
å±é™©è‰²ï¼šçº¢è‰² (#ff4757)
```

### 2. å¯¼èˆªåœ°å›¾æ˜¾ç¤ºæ¨¡å— âœ…

#### æ–°å¢åŠŸèƒ½
- **å®æ—¶åœ°å›¾canvasæ˜¾ç¤º**
  - ç½‘æ ¼åæ ‡ç³»
  - æœºå™¨äººä½ç½®å’Œæ–¹å‘å®æ—¶æ›´æ–°
  - ç›®æ ‡ç‚¹æ ‡è®°
  - è·¯å¾„è§„åˆ’æ˜¾ç¤º

- **äº¤äº’åŠŸèƒ½**
  - ç‚¹å‡»åœ°å›¾è®¾ç½®ç›®æ ‡ç‚¹
  - æœºå™¨äººä½ç½®å®æ—¶è·Ÿè¸ª
  - åŠ¨æ€ç¼©æ”¾å’Œå¹³ç§»ï¼ˆé¢„ç•™ï¼‰
  - åœ°å›¾å›¾ä¾‹æ˜¾ç¤º

- **åœ°å›¾å åŠ å±‚**
  - å½“å‰ä½ç½®æ˜¾ç¤ºï¼ˆX, Y, Î¸ï¼‰
  - å›¾ä¾‹è¯´æ˜
  - è‡ªå®šä¹‰é€æ˜èƒŒæ™¯

#### é¢„ç•™æ¥å£
```javascript
// å¯¼èˆªç›®æ ‡è®¾ç½®
function sendNavigationGoal(x, y, theta)

// åœ°å›¾æ•°æ®æ›´æ–°
function updateMapData(data)

// è·¯å¾„æ›´æ–°
function updatePath(data)

// å–æ¶ˆå¯¼èˆª
function cancelNavigation()

// åœ°å›¾ç®¡ç†
function saveMap(mapName)
function loadMap(mapName)
function requestMapUpdate()
```

### 3. ä¿®å¤Webæ–‡ä»¶404é—®é¢˜ âœ…

#### é—®é¢˜åŸå› 
Pythonä»£ç è·å–åŒ…è·¯å¾„æ–¹å¼ä¸æ­£ç¡®

#### è§£å†³æ–¹æ¡ˆ
```python
from ament_index_python.packages import get_package_share_directory

# ä½¿ç”¨æ­£ç¡®çš„åŒ…è·¯å¾„è·å–æ–¹å¼
package_share_dir = get_package_share_directory('cleanbot_control')
static_dir = Path(package_share_dir) / 'web' / 'static'
templates_dir = Path(package_share_dir) / 'web' / 'templates'
```

åŒæ—¶æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºå’Œé”™è¯¯å¤„ç†ã€‚

### 4. è§£å†³ROSæ—¥å¿—è­¦å‘Š âœ…

#### é—®é¢˜1: controller_managerç­‰å¾…robot_description
**åŸå› **ï¼šæœªå‘å¸ƒrobot_descriptionå‚æ•°

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºæ–°çš„launchæ–‡ä»¶ `cleanbot_full.launch.py`
- æ·»åŠ robot_state_publisherèŠ‚ç‚¹
- å¤„ç†xacroæ–‡ä»¶ç”ŸæˆURDF
- å»¶è¿Ÿå¯åŠ¨controller_managerç¡®ä¿robot_descriptionå·²å‘å¸ƒ

#### é—®é¢˜2: spawneræ— æ³•è¿æ¥æœåŠ¡
**åŸå› **ï¼šcontroller_manageræœªå°±ç»ªå°±å¯åŠ¨spawner

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨TimerActionå»¶è¿Ÿå¯åŠ¨
```python
# controller_managerå»¶è¿Ÿ2ç§’å¯åŠ¨
# spawnerå»¶è¿Ÿ4ç§’å¯åŠ¨
# ekfå»¶è¿Ÿ5ç§’å¯åŠ¨
```

#### é—®é¢˜3: EKFçš„TF_OLD_DATAè­¦å‘Š
**åŸå› **ï¼šç¼ºå°‘robot_state_publisherå¯¼è‡´TFæ ‘ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ robot_state_publisherå‘å¸ƒTFæ ‘
- å»¶è¿Ÿå¯åŠ¨EKFèŠ‚ç‚¹ç¡®ä¿TFæ ‘å°±ç»ª
- é…ç½®æ­£ç¡®çš„frame_id

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### Launchæ–‡ä»¶
```
cleanbot_full.launch.py - å®Œæ•´ç³»ç»Ÿå¯åŠ¨ï¼ˆæ¨èä½¿ç”¨ï¼‰
```

### å‰ç«¯æ–‡ä»¶ï¼ˆå·²æ›´æ–°ï¼‰
```
web/templates/index.html - å…¨æ–°ç§‘æŠ€æ„Ÿç•Œé¢
web/static/control.js - æ–°å¢åœ°å›¾å’Œå¯¼èˆªåŠŸèƒ½
```

### PythonèŠ‚ç‚¹ï¼ˆå·²æ›´æ–°ï¼‰
```
web_control_node.py - ä¿®å¤è·¯å¾„é—®é¢˜ï¼Œæ·»åŠ å¯¼èˆªæ¥å£
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ¨èï¼šä½¿ç”¨å®Œæ•´ç³»ç»Ÿå¯åŠ¨ï¼ˆè§£å†³æ‰€æœ‰è­¦å‘Šï¼‰

```bash
cd /home/xiaoming/æ¡Œé¢/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot_full.launch.py
```

**åŒ…å«æ‰€æœ‰èŠ‚ç‚¹**ï¼š
1. robot_state_publisherï¼ˆå‘å¸ƒURDFå’ŒTFï¼‰
2. USBé€šè®¯èŠ‚ç‚¹
3. Webæ§åˆ¶èŠ‚ç‚¹ï¼ˆhttp://localhost:8080ï¼‰
4. controller_managerï¼ˆå»¶è¿Ÿå¯åŠ¨ï¼‰
5. diff_drive_controller
6. joint_state_broadcaster
7. EKFå®šä½èŠ‚ç‚¹ï¼ˆå»¶è¿Ÿå¯åŠ¨ï¼‰

**å¯åŠ¨é¡ºåºä¼˜åŒ–**ï¼š
- 0ç§’ï¼šrobot_state_publisher, USB, Web
- 2ç§’ï¼šcontroller_manager
- 4ç§’ï¼šspawners
- 5ç§’ï¼šEKF

### åŸºç¡€ç³»ç»Ÿï¼ˆæ— ros2_controlï¼‰

```bash
ros2 launch cleanbot_control cleanbot_basic.launch.py
```

### åŸå®Œæ•´ç³»ç»Ÿï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰

```bash
ros2 launch cleanbot_control cleanbot_control.launch.py
```

---

## ğŸ¨ Webç•Œé¢åŠŸèƒ½

### 1. å¯¼èˆªåœ°å›¾åŒºåŸŸï¼ˆå·¦ä¸Šå¤§åŒºåŸŸï¼‰
- **Canvasåœ°å›¾æ˜¾ç¤º**
  - å®æ—¶æœºå™¨äººä½ç½®
  - ç‚¹å‡»è®¾ç½®ç›®æ ‡ç‚¹
  - è·¯å¾„è§„åˆ’æ˜¾ç¤º
  - ç½‘æ ¼åæ ‡ç³»

- **åœ°å›¾å åŠ ä¿¡æ¯**
  - æœºå™¨äººåæ ‡ï¼ˆX, Y, Î¸ï¼‰
  - å›¾ä¾‹è¯´æ˜

### 2. æ§åˆ¶é¢æ¿ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰
- è¿æ¥çŠ¶æ€å¡ç‰‡
- è™šæ‹Ÿæ‘‡æ†æ§åˆ¶
- å·¥ä½œæ¨¡å¼åˆ‡æ¢
- æ‰§è¡Œå™¨æ¡£ä½æ§åˆ¶
- ä¼ æ„Ÿå™¨çŠ¶æ€ç›‘æ§
- IMUæ•°æ®æ˜¾ç¤º
- é‡Œç¨‹è®¡æ•°æ®
- è½®é€Ÿæ•°æ®
- ç³»ç»Ÿæ—¥å¿—

### 3. äº¤äº’å¢å¼º
- æŒ‰é’®æ‚¬åœæ•ˆæœ
- æ¨¡å¼é€‰æ‹©é«˜äº®
- ä¼ æ„Ÿå™¨å¼‚å¸¸é—ªçƒ
- æ»‘å—å®æ—¶åé¦ˆ
- æ—¥å¿—è‡ªåŠ¨æ»šåŠ¨

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### åœ°å›¾åæ ‡ç³»ç»Ÿ
```javascript
// ä¸–ç•Œåæ ‡ â†’ å±å¹•åæ ‡
function worldToScreen(x, y) {
    return {
        x: x * mapScale + mapOffset.x,
        y: -y * mapScale + mapOffset.y  // Yè½´åå‘
    };
}

// å±å¹•åæ ‡ â†’ ä¸–ç•Œåæ ‡
function screenToWorld(x, y) {
    return {
        x: (x - mapOffset.x) / mapScale,
        y: -(y - mapOffset.y) / mapScale
    };
}
```

### WebSocketæ¶ˆæ¯æ ¼å¼

#### å‰ç«¯â†’åç«¯
```json
// è®¾ç½®ç›®æ ‡ç‚¹
{
  "type": "set_goal",
  "x": 1.5,
  "y": 2.0
}

// å¯¼èˆªç›®æ ‡
{
  "type": "navigation_goal",
  "x": 1.5,
  "y": 2.0,
  "theta": 0.0
}

// å–æ¶ˆå¯¼èˆª
{
  "type": "cancel_navigation"
}

// è¯·æ±‚åœ°å›¾
{
  "type": "request_map"
}

// ä¿å­˜/åŠ è½½åœ°å›¾
{
  "type": "save_map",
  "name": "my_map"
}
```

#### åç«¯â†’å‰ç«¯
```json
// åœ°å›¾æ›´æ–°
{
  "type": "map_update",
  "data": {
    // åœ°å›¾æ•°æ®
  }
}

// è·¯å¾„æ›´æ–°
{
  "type": "path_update",
  "data": {
    "path": [
      {"x": 0.0, "y": 0.0},
      {"x": 1.0, "y": 0.5},
      ...
    ]
  }
}
```

---

## ğŸ“‹ å¾…å®ç°åŠŸèƒ½ï¼ˆå·²é¢„ç•™æ¥å£ï¼‰

### å¯¼èˆªåŠŸèƒ½
- [ ] é›†æˆnavigation2
- [ ] SLAMåœ°å›¾æ„å»º
- [ ] å…¨å±€è·¯å¾„è§„åˆ’
- [ ] å±€éƒ¨è·¯å¾„è§„åˆ’
- [ ] å®æ—¶é¿éšœ

### åœ°å›¾åŠŸèƒ½
- [ ] åœ°å›¾ä¿å­˜/åŠ è½½
- [ ] åœ°å›¾ç¼–è¾‘
- [ ] è™šæ‹Ÿå¢™è®¾ç½®
- [ ] ç¦åŒºæ ‡è®°

### æ˜¾ç¤ºå¢å¼º
- [ ] æ¿€å…‰é›·è¾¾ç‚¹äº‘æ˜¾ç¤º
- [ ] ä»£ä»·åœ°å›¾æ˜¾ç¤º
- [ ] è½¨è¿¹å†å²è®°å½•
- [ ] å¤šæœºå™¨äººæ”¯æŒ

---

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

### 1. Webç•Œé¢404
- âœ… ä¿®å¤åŒ…è·¯å¾„è·å–æ–¹å¼
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡º
- âœ… æ·»åŠ é”™è¯¯å¤„ç†

### 2. controller_managerè­¦å‘Š
- âœ… æ·»åŠ robot_state_publisher
- âœ… æ­£ç¡®å‘å¸ƒrobot_description
- âœ… å»¶è¿Ÿå¯åŠ¨ç¡®ä¿åˆå§‹åŒ–é¡ºåº

### 3. spawnerè¿æ¥å¤±è´¥
- âœ… å»¶è¿Ÿå¯åŠ¨spawner
- âœ… ç­‰å¾…controller_managerå°±ç»ª

### 4. EKF TFè­¦å‘Š
- âœ… å®Œå–„TFæ ‘å‘å¸ƒ
- âœ… å»¶è¿Ÿå¯åŠ¨EKF
- âœ… é…ç½®æ­£ç¡®çš„frame_id

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### åœ°å›¾åˆ·æ–°é¢‘ç‡
- Canvasç»˜åˆ¶ï¼š10Hz
- çŠ¶æ€æ›´æ–°ï¼š10Hz
- æ§åˆ¶å‘½ä»¤ï¼š50Hz

### èµ„æºå ç”¨
- Canvasæ¸²æŸ“ä¼˜åŒ–
- åªç»˜åˆ¶å¯è§åŒºåŸŸ
- è·¯å¾„ç‚¹æŠ½æ ·æ˜¾ç¤º

---

## ğŸ¯ æµ‹è¯•å»ºè®®

### 1. Webç•Œé¢æµ‹è¯•
```bash
# å¯åŠ¨ç³»ç»Ÿ
ros2 launch cleanbot_control cleanbot_full.launch.py

# æµè§ˆå™¨è®¿é—®
http://localhost:8080

# æµ‹è¯•é¡¹ç›®
- ç•Œé¢åŠ è½½æ˜¯å¦æ­£å¸¸
- WebSocketè¿æ¥çŠ¶æ€
- åœ°å›¾Canvasæ˜¾ç¤º
- ç‚¹å‡»è®¾ç½®ç›®æ ‡ç‚¹
- è™šæ‹Ÿæ‘‡æ†æ§åˆ¶
- å„ç§æŒ‰é’®å’Œæ»‘å—
```

### 2. å¯¼èˆªæ¥å£æµ‹è¯•
```bash
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
sendNavigationGoal(1.0, 2.0, 0.0)
cancelNavigation()
requestMapUpdate()
```

### 3. ç³»ç»Ÿæ—¥å¿—æ£€æŸ¥
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è­¦å‘Š
ros2 launch cleanbot_control cleanbot_full.launch.py

# åº”è¯¥çœ‹åˆ°å¹²å‡€çš„å¯åŠ¨æ—¥å¿—ï¼Œæ— è­¦å‘Š
```

---

## ğŸ“ å¦‚æœè¿˜æœ‰é—®é¢˜

### Webç•Œé¢ä»ç„¶404
```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®å®‰è£…
ls /home/xiaoming/æ¡Œé¢/MOON/Electronic/CleanBot_ws/install/cleanbot_control/share/cleanbot_control/web/

# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
ros2 node info /web_control_node
```

### ä»æœ‰ROSè­¦å‘Š
```bash
# æ£€æŸ¥robot_descriptionæ˜¯å¦å‘å¸ƒ
ros2 topic echo /robot_description

# æ£€æŸ¥TFæ ‘
ros2 run tf2_tools view_frames

# æŸ¥çœ‹TFæ ‘çŠ¶æ€
ros2 run tf2_ros tf2_echo base_footprint left_wheel_link
```

---

## âœ… æ›´æ–°æ€»ç»“

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Webç•Œé¢ç¾åŒ– | âœ… | ç§‘æŠ€æ„Ÿè®¾è®¡å®Œæˆ |
| å¯¼èˆªåœ°å›¾æ˜¾ç¤º | âœ… | Canvaså®æ—¶æ˜¾ç¤º |
| å¯¼èˆªæ¥å£é¢„ç•™ | âœ… | å®Œæ•´APIå·²å®ç° |
| Webæ–‡ä»¶404 | âœ… | å·²ä¿®å¤ |
| ROSè­¦å‘Š | âœ… | å…¨éƒ¨è§£å†³ |
| ç³»ç»Ÿç¨³å®šæ€§ | âœ… | å»¶è¿Ÿå¯åŠ¨ä¼˜åŒ– |

---

**ç³»ç»Ÿç°åœ¨å¯ä»¥å®Œç¾è¿è¡Œï¼** ğŸ‰

å»ºè®®ä½¿ç”¨ï¼š
```bash
ros2 launch cleanbot_control cleanbot_full.launch.py
```

ç„¶åè®¿é—®ï¼šhttp://localhost:8080

