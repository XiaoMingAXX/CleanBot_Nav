# CleanBot 统一导航启动说明

## 概述

已将实机和仿真导航系统整合到单一启动文件 `navigation.launch.py`，通过 `sim_mode` 参数控制运行模式。

## 启动方法

### 仿真模式（Gazebo）
```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash

# 完整启动：仿真模式 + 启用RViz
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=true

# 仿真模式 + 不启动RViz
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=true enable_rviz:=false
```

### 实机模式（真实硬件）
```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash

# 实机模式（默认不启动RViz）
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=false

# 实机模式 + 启动RViz
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=false enable_rviz:=true
```

## 参数说明

| 参数 | 默认值 | 说明 |
|-----|--------|------|
| `sim_mode` | `false` | 仿真模式开关 (true=仿真, false=实机) |
| `use_sim_time` | 自动 | 使用仿真时间 (自动根据sim_mode设置) |
| `autostart` | `false` | 自动启动Nav2栈 (由mode_manager控制) |
| `map` | `''` | 地图YAML文件路径 (导航模式使用) |
| `enable_rviz` | 自动 | 是否启动RViz (仿真默认true，实机默认false) |

## 自动适配功能

启动文件会根据 `sim_mode` 自动调整以下配置：

### 仿真模式 (sim_mode=true)
- ✅ 启用仿真时间 (`use_sim_time=true`)
- ✅ 使用Gazebo提供的激光雷达数据 (`/scan`)
- ✅ 网络发现范围：LOCALHOST
- ✅ SLAM/AMCL容差：较大 (0.5s)
- ✅ 默认启动RViz可视化

### 实机模式 (sim_mode=false)
- ✅ 关闭仿真时间 (`use_sim_time=false`)
- ✅ 启动真实激光雷达 (rplidar_a1)
- ✅ 网络发现范围：SUBNET
- ✅ SLAM/AMCL容差：较小 (0.3s)
- ✅ 默认不启动RViz（节省资源）

## 配置文件

### 统一使用的配置文件
- **SLAM配置**: `config/slam_toolbox.yaml`
- **Nav2配置**: `config/nav2_params.yaml` （实机和仿真共用）
- **AMCL配置**: `config/amcl.yaml`
- **清扫任务配置**: `config/cleaning_task_params.yaml`

**注意**: `nav2_sim_params.yaml` 已废弃，所有模式统一使用 `nav2_params.yaml`

## 与旧版launch文件的对比

### 旧版（已废弃）
- `navigation_bringup.launch.py` - 实机专用
- `navigation_sim.launch.py` - 仿真专用

### 新版（推荐）
- `navigation.launch.py` - 统一启动文件

**迁移指南**:
```bash
# 旧版实机启动
ros2 launch cleanbot_navigation navigation_bringup.launch.py

# 新版实机启动
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=false

# 旧版仿真启动
ros2 launch cleanbot_navigation navigation_sim.launch.py

# 新版仿真启动
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=true
```

## 完整系统启动示例

### 仿真环境完整启动
```bash
# 终端1：启动Gazebo + 控制系统
ros2 launch cleanbot_control cleanbot_gazebo.launch.py

# 终端2：启动导航系统（仿真模式）
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=true
```

### 实机环境完整启动
```bash
# 终端1：启动控制系统
ros2 launch cleanbot_control cleanbot.launch.py

# 终端2：启动导航系统（实机模式）
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=false

# 终端3（可选）：远程RViz可视化
ros2 launch cleanbot_navigation remote.launch.py
```

## 故障排除

### 问题1：仿真模式下TF延迟警告
**原因**: 仿真时钟未正确同步

**解决方法**:
```bash
# 确认Gazebo正在运行
ros2 topic list | grep clock

# 确认use_sim_time正确设置
ros2 param get /slam_toolbox use_sim_time
```

### 问题2：实机模式下激光雷达未启动
**原因**: 串口设备不存在或被占用

**解决方法**:
```bash
# 检查串口设备
ls -l /dev/ttyUSB*

# 添加串口权限
sudo chmod 666 /dev/ttyUSB0
```

### 问题3：参数设置不生效
**原因**: use_sim_time在节点启动后不能动态修改

**解决方法**:
```bash
# 重启导航系统，确保正确传入参数
ros2 launch cleanbot_navigation navigation.launch.py sim_mode:=true
```

## 高级用法

### 指定地图文件启动导航
```bash
# 实机模式 + 指定地图
ros2 launch cleanbot_navigation navigation.launch.py \
  sim_mode:=false \
  map:=~/cleanbot_maps/my_map.yaml

# 仿真模式 + 指定地图
ros2 launch cleanbot_navigation navigation.launch.py \
  sim_mode:=true \
  map:=~/cleanbot_maps/my_map.yaml
```

### 自动启动Nav2栈（不推荐）
```bash
# 跳过mode_manager控制，直接启动Nav2
ros2 launch cleanbot_navigation navigation.launch.py \
  sim_mode:=false \
  autostart:=true
```

## 与语音控制集成

语音控制节点会自动发布导航模式切换命令到 `/navigation/mode_cmd`，与统一导航系统无缝集成：

- **语音"建图模式"** → 启动SLAM Toolbox
- **语音"导航模式"** → 加载地图并启动AMCL
- **语音"手动模式"** → 关闭SLAM和导航

详见：`docs/语音控制节点使用说明.md`

## 总结

通过统一launch文件，您可以：
1. ✅ 用单一命令在实机和仿真间快速切换
2. ✅ 减少配置文件维护成本
3. ✅ 避免参数不一致导致的问题
4. ✅ 更清晰的启动参数管理

旧版launch文件保留但建议使用新版统一文件。

