# 前端导航功能增强说明

**日期**：2025-12-15  
**版本**：v1.1

## 修复的Bug

### 🐛 Bug #1：建图模式下摇杆被禁用

**问题描述**：
- 原代码：`joystickEnabled = (mode === 0);`
- 错误逻辑：只有手动模式(0)才启用摇杆
- 实际需求：建图模式(1)也需要摇杆来手动驾驶建图

**修复方案**：
```javascript
// 修改前（错误）
joystickEnabled = (mode === 0);  // 只有手动模式

// 修改后（正确）
joystickEnabled = (mode !== 2);  // 导航模式禁用，其他启用
```

**摇杆启用规则**：
- ✅ 手动模式(0)：启用摇杆
- ✅ 建图模式(1)：启用摇杆（需要手动驾驶）
- ❌ 导航模式(2)：禁用摇杆（自主导航）

## 新增功能

### ✨ 功能 #1：模式切换状态反馈

**位置**：导航模式面板

**显示内容**：
- 切换中：⚠️ 黄色 "切换中..."
- 完成：✅ 绿色 "就绪"
- 保存地图中：⚠️ 黄色 "保存中..."
- 地图已保存：✅ 绿色 "地图已保存"

**实现**：
```javascript
// 切换时
document.getElementById('nav-mode-state').textContent = '切换中...';
document.getElementById('nav-mode-state').style.color = 'var(--warning)';

// 完成时（从ROS接收navigation_info消息）
document.getElementById('nav-mode-state').textContent = '✅ 就绪';
document.getElementById('nav-mode-state').style.color = 'var(--success)';
```

### ✨ 功能 #2：地图保存成功反馈

**反馈方式**：
1. 状态显示更新为 "✅ 地图已保存"
2. 系统日志输出：`✅ 地图保存成功: cleanbot_map_20251215_xxx`
3. 自动刷新地图列表

**触发条件**：
收到 `navigation_info` 消息，内容为 `map_saved:地图名称`

### ✨ 功能 #3：地图列表和选择

**功能描述**：
- 自动扫描 `~/cleanbot_maps/` 目录
- 显示所有可用地图（.yaml文件）
- 按时间倒序排列（最新的在前）
- 可选择地图用于导航

**UI组件**：

**建图模式**（mode=1）：
```html
<button>💾 保存地图</button>
```

**导航模式**（mode=2）：
```html
<select id="map-select">
    <option>选择地图...</option>
    <option>cleanbot_map_20251215_200840</option>
    <option>cleanbot_map_20251214_153020</option>
</select>
<button>📍 加载地图</button>
<button>🔄 刷新列表</button>
```

**JavaScript函数**：
```javascript
// 刷新地图列表
function refreshMapList() {
    sendWebSocketMessage({ type: 'list_maps' });
}

// 加载选中的地图
function loadSelectedMap() {
    const mapPath = document.getElementById('map-select').value;
    sendWebSocketMessage({ 
        type: 'load_map', 
        map_path: mapPath 
    });
}

// 更新地图列表（从服务器接收）
function updateMapList(maps) {
    // 填充下拉列表
    maps.forEach(mapPath => {
        const mapName = mapPath.split('/').pop().replace('.yaml', '');
        // 添加到select
    });
}
```

## 消息协议扩展

### 前端 → 后端

**1. 列出地图**
```json
{
    "type": "list_maps"
}
```

**2. 加载地图**
```json
{
    "type": "load_map",
    "map_path": "/home/xiaoming/cleanbot_maps/cleanbot_map_xxx.yaml"
}
```

### 后端 → 前端

**1. 地图列表**
```json
{
    "type": "map_list",
    "maps": [
        "/home/xiaoming/cleanbot_maps/cleanbot_map_20251215_200840.yaml",
        "/home/xiaoming/cleanbot_maps/cleanbot_map_20251214_153020.yaml"
    ]
}
```

**2. 导航信息**
```json
{
    "type": "navigation_info",
    "message": "mode_changed:mapping"
}
```
或
```json
{
    "type": "navigation_info",
    "message": "map_saved:cleanbot_map_20251215_200840"
}
```

## UI改进

### 导航模式面板布局

**通用部分**：
- 模式切换按钮（手动/建图/导航）
- 当前模式显示
- 状态显示（新增）

**模式特定控件**：
- 手动模式：无特殊控件
- 建图模式：显示"保存地图"按钮
- 导航模式：显示地图选择和加载按钮

**信息提示**：
- 手动模式：`✅ 摇杆控制已启用`
- 建图模式：`✅ 摇杆可用，驾驶建图`
- 导航模式：`⚠️ 自主导航中，摇杆已禁用`

### 用户体验优化

1. **即时反馈**：
   - 点击切换模式 → 立即显示"切换中..."
   - 切换完成 → 显示"✅ 就绪"
   
2. **智能控件显示**：
   - 根据当前模式自动显示/隐藏对应控件
   - 建图模式只显示保存按钮
   - 导航模式只显示地图选择

3. **自动刷新**：
   - 保存地图后自动刷新地图列表
   - 切换到导航模式时自动刷新列表
   - 页面加载时预加载地图列表

## 后端实现

### web_control_node.py 新增处理

**1. 列出地图**
```python
elif cmd_type == 'list_maps':
    import glob
    map_dir = os.path.expanduser('~/cleanbot_maps')
    if os.path.exists(map_dir):
        map_files = glob.glob(os.path.join(map_dir, '*.yaml'))
        map_files.sort(reverse=True)  # 最新的在前
        await ws.send_str(json.dumps({
            'type': 'map_list',
            'maps': map_files
        }))
```

**2. 加载地图**
```python
elif cmd_type == 'load_map':
    map_path = data.get('map_path', '')
    self.get_logger().info(f'请求加载地图: {map_path}')
    # 实际加载需要重启nav2
    await ws.send_str(json.dumps({
        'type': 'info',
        'message': f'地图路径已设置'
    }))
```

## 使用流程

### 建图流程
1. 切换到"建图"模式
2. 等待状态变为"✅ 就绪"
3. 使用摇杆手动驾驶建图
4. 完成后点击"💾 保存地图"
5. 等待"✅ 地图已保存"提示
6. 地图列表自动更新

### 导航流程
1. 切换到"导航"模式
2. 等待状态变为"✅ 就绪"
3. 从下拉列表选择地图
4. 点击"📍 加载地图"
5. （注意：实际使用需要在启动时指定地图）
6. 在RViz2中设置目标点

## 注意事项

### 地图加载限制

当前实现中，地图选择只是保存选择的路径，**实际加载地图需要重启导航系统**。

**原因**：
- Nav2的map_server需要在启动时加载地图
- 运行时切换地图需要重新配置和激活节点

**解决方案**：
1. **临时方案**：
   - 用户选择地图后记录路径
   - 重启导航系统时使用该地图
   
2. **完善方案**（待实现）：
   - 通过lifecycle服务动态切换地图
   - 调用map_server的change_map服务

### 文件路径

- 地图保存目录：`~/cleanbot_maps/`
- 地图命名格式：`cleanbot_map_YYYYMMDD_HHMMSS.yaml`
- 配套图像文件：`cleanbot_map_YYYYMMDD_HHMMSS.pgm`

## 测试检查清单

### 摇杆控制测试
- [ ] 手动模式：摇杆可用 ✅
- [ ] 建图模式：摇杆可用 ✅（修复后）
- [ ] 导航模式：摇杆禁用 ✅

### 状态反馈测试
- [ ] 切换模式时显示"切换中..."
- [ ] 切换完成显示"✅ 就绪"
- [ ] 保存地图时显示"保存中..."
- [ ] 保存完成显示"✅ 地图已保存"

### 地图管理测试
- [ ] 页面加载时显示地图列表
- [ ] 保存地图后列表自动刷新
- [ ] 切换到导航模式时刷新列表
- [ ] 手动点击刷新按钮更新列表
- [ ] 选择地图并加载

### 日志输出测试
- [ ] 模式切换请求有日志
- [ ] 模式切换完成有日志
- [ ] 地图保存成功有日志
- [ ] 发现地图数量有日志

## 文件修改清单

### 前端文件
1. ✅ `web/templates/index.html`
   - 添加状态显示
   - 添加地图选择控件
   - 动态显示/隐藏控件

2. ✅ `web/static/control.js`
   - 修复摇杆启用逻辑
   - 添加状态反馈处理
   - 添加地图列表功能
   - 添加地图加载功能

### 后端文件
3. ✅ `scripts/web_control_node.py`
   - 添加list_maps处理
   - 添加load_map处理

### 导航节点
4. ✅ `cleanbot_navigation/navigation_mode_manager.py`
   - 修复save_map_timeout参数类型

## 版本历史

- v1.0 (2025-12-14)：初始导航系统实现
- v1.1 (2025-12-15)：
  - 修复建图模式摇杆禁用bug
  - 添加状态反馈
  - 添加地图列表和选择功能

---

**改进建议**：欢迎提出更多功能需求！







