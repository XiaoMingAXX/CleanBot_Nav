# 真实状态反馈测试清单

## 🔄 编译和启动

```bash
cd ~/桌面/MOON/Electronic/CleanBot_ws

# 编译
colcon build --packages-select cleanbot_control cleanbot_navigation

# 刷新
source install/setup.bash

# 启动系统（3个终端）
# 终端1
ros2 launch cleanbot_control robot_bringup.launch.py

# 终端2  
ros2 launch cleanbot_control web_control.launch.py

# 终端3
ros2 launch cleanbot_navigation navigation_bringup.launch.py

# 浏览器
http://localhost:8080
```

## ✅ 测试清单

### 测试1：控件是否显示

#### 建图模式
- [ ] 切换到"建图"模式
- [ ] **应该看到**："💾 保存地图"按钮
- [ ] **不应看到**：地图选择控件

#### 导航模式
- [ ] 切换到"导航"模式
- [ ] **应该看到**：
  - 地图选择下拉框
  - "📍 加载地图"按钮
  - "🔄 刷新列表"按钮
- [ ] **不应看到**：保存地图按钮

**如果看不到**：
```javascript
// 打开浏览器Console（F12），输入：
console.log('建图控件:', document.getElementById('mapping-controls'));
console.log('导航控件:', document.getElementById('navigation-controls'));
// 应该看到DOM元素，不是null
```

---

### 测试2：真实状态反馈

#### 手动 → 建图
1. [ ] 点击"建图"按钮
2. [ ] **立即显示**：`⏳ 启动中...` (黄色)
3. [ ] **几秒后**：`⏳ SLAM启动中...` (黄色)
4. [ ] **完成后**：`✅ 就绪` (绿色)
5. [ ] **日志显示**：
   ```
   📡 请求切换导航模式: 建图
   ⏳ 正在激活SLAM节点...
   ✅ 模式切换完成: mapping
   ```

#### 手动 → 导航
1. [ ] 点击"导航"按钮
2. [ ] **立即显示**：`⏳ 启动中...` (黄色)
3. [ ] **几秒后**：`⏳ 导航启动中...` (黄色)
4. [ ] **完成后**：`✅ 就绪` (绿色)
5. [ ] **地图列表自动刷新**
6. [ ] **日志显示**：
   ```
   📡 请求切换导航模式: 导航
   ⏳ 正在激活导航节点...
   ✅ 模式切换完成: navigation
   ```

---

### 测试3：地图保存反馈

#### 准备工作
1. [ ] 切换到建图模式，等待"✅ 就绪"
2. [ ] 使用摇杆驾驶机器人移动（建图）
3. [ ] 在RViz2中观察地图生成

#### 保存地图
1. [ ] 点击"💾 保存地图"按钮
2. [ ] **立即变化**：
   - 按钮变为"💾 保存中..."
   - 按钮变灰（禁用）
   - 状态显示"💾 保存中..." (黄色)
3. [ ] **日志显示**：`📡 发送保存地图请求...`
4. [ ] **等待几秒...**
5. [ ] **保存成功后**：
   - 状态变为"✅ 已保存" (绿色)
   - 按钮恢复为"💾 保存地图"（可用）
   - 日志显示：`✅ 地图保存成功: cleanbot_map_xxx`
   - 1秒后刷新地图列表
   - 状态恢复为"✅ 就绪"

#### 验证地图文件
```bash
ls -lh ~/cleanbot_maps/
# 应该看到新生成的地图：
# cleanbot_map_20251215_xxx.yaml
# cleanbot_map_20251215_xxx.pgm
```

---

### 测试4：地图列表

#### 自动刷新
1. [ ] 保存地图成功后
2. [ ] 切换到"导航"模式
3. [ ] 打开地图下拉框
4. [ ] **应该看到**：刚保存的地图在列表顶部

#### 手动刷新
1. [ ] 在导航模式下
2. [ ] 点击"🔄 刷新列表"按钮
3. [ ] 日志显示：`✅ 发现 X 个地图`
4. [ ] 下拉框更新

---

### 测试5：地图加载

1. [ ] 切换到导航模式，等待"✅ 就绪"
2. [ ] 从下拉框选择一个地图
3. [ ] 点击"📍 加载地图"按钮
4. [ ] 状态显示"加载地图中..."
5. [ ] 日志显示：`📡 加载地图: xxx`
6. [ ] 收到反馈消息

---

## 🐛 常见问题

### Q1: 状态一直显示"启动中..."不变

**检查**：
```bash
# 终端4：监听导航信息
ros2 topic echo /navigation/info
```

**应该看到**：
```
data: 'slam_activating'
data: 'mode_changed:mapping'
```

**如果没有**：
- 检查navigation_mode_manager是否运行：`ros2 node list | grep navigation`
- 查看节点日志中的错误信息

### Q2: 控件完全看不到

**刷新页面**：
```
Ctrl + F5 (强制刷新，清除缓存)
```

**检查JavaScript错误**：
```
F12 → Console标签
查看是否有红色错误消息
```

### Q3: 保存按钮点击后无响应

**检查建图模式**：
- 确保当前在建图模式（不是手动或导航）
- 状态显示为"✅ 就绪"

**检查地图是否在生成**：
```bash
# 查看/map话题
ros2 topic hz /map
# 应该有数据更新
```

### Q4: 地图列表为空

**检查目录**：
```bash
ls -la ~/cleanbot_maps/
```

**创建测试地图**：
- 先建图并保存一次
- 或手动创建测试文件

---

## 📊 预期行为总结

| 动作 | 立即显示 | 中间状态 | 最终状态 | 时长 |
|------|---------|---------|---------|------|
| 切换到建图 | ⏳ 启动中 | ⏳ SLAM启动中 | ✅ 就绪 | 3-5秒 |
| 切换到导航 | ⏳ 启动中 | ⏳ 导航启动中 | ✅ 就绪 | 5-8秒 |
| 保存地图 | 💾 保存中 | - | ✅ 已保存 → ✅ 就绪 | 5-10秒 |
| 保存失败 | 💾 保存中 | - | ❌ 保存失败 → ✅ 就绪 | 5-10秒 |

---

## ✨ 成功标准

- [x] 控件根据模式正确显示/隐藏
- [x] 状态实时反映后端真实状态
- [x] 不会出现"假的就绪"
- [x] 保存地图有明确的成功/失败反馈
- [x] 按钮状态正确控制（禁用/启用）
- [x] 地图列表自动刷新
- [x] 日志输出清晰完整

---

## 📞 需要帮助？

如果测试中遇到问题：

1. **查看浏览器Console**（F12）
2. **查看ROS节点日志**（终端输出）
3. **检查话题数据**：
   ```bash
   ros2 topic list
   ros2 topic echo /navigation/info
   ros2 topic echo /navigation/mode_status
   ```
4. **参考文档**：`docs/导航状态真实反馈实现.md`

---

**测试愉快！** 🚀




