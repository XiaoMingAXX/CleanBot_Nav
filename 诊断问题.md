# 导航系统问题诊断与修复

## 问题描述
1. **地图列表无法加载**：点击刷新列表没有反应，下拉框为空
2. **摇杆控制时好时坏**：大部分时候无法正常控制机器人

## 问题分析

### 问题1：地图列表无法加载

**根本原因**：
- `window.onload` 时立即调用 `refreshMapList()`
- 此时WebSocket可能还未连接成功
- 导致消息发送失败，地图列表无法获取

**修复方案**：
- 移除 `window.onload` 中的 `refreshMapList()` 调用
- 在 `ws.onopen` 回调中延迟500ms后自动刷新地图列表
- 确保WebSocket连接成功后再发送请求

### 问题2：摇杆控制不稳定

**可能原因**：
1. WebSocket连接不稳定，消息丢失
2. 大量重复的零速度消息占用带宽
3. `joystickEnabled` 状态管理混乱

**修复方案**：
1. **优化消息发送**：
   - 只在速度值改变时发送消息
   - 添加 `lastSentLinear` 和 `lastSentAngular` 跟踪上次发送的值
   - 避免重复发送相同的速度命令

2. **改进错误处理**：
   - 添加 try-catch 捕获WebSocket发送异常
   - 对非关键消息（cmd_vel）不打印警告，避免日志刷屏

3. **添加调试信息**：
   - 在模式切换时打印摇杆状态
   - 帮助诊断 `joystickEnabled` 是否正确

## 修改的代码

### 1. WebSocket连接成功后刷新地图列表

```javascript
ws.onopen = function() {
    updateConnectionStatus(true);
    addLog('WebSocket连接成功');
    if (reconnectInterval) {
        clearInterval(reconnectInterval);
        reconnectInterval = null;
    }
    // WebSocket连接成功后，刷新地图列表
    setTimeout(() => {
        refreshMapList();
    }, 500);
};
```

### 2. 优化速度命令发送

```javascript
// 上一次发送的速度值（用于检测变化）
let lastSentLinear = 0;
let lastSentAngular = 0;

function sendVelocityCommand() {
    // 在导航模式下禁用摇杆控制
    if (!joystickEnabled) {
        return;
    }
    
    // 只在速度改变时发送（避免大量重复消息）
    if (currentLinear === lastSentLinear && currentAngular === lastSentAngular) {
        return;
    }
    
    const msg = {
        type: 'cmd_vel',
        linear: currentLinear,
        angular: currentAngular
    };
    
    sendWebSocketMessage(msg);
    
    // 记录已发送的速度
    lastSentLinear = currentLinear;
    lastSentAngular = currentAngular;
}
```

### 3. 改进WebSocket消息发送

```javascript
function sendWebSocketMessage(message) {
    if (ws && ws.readyState === WebSocket.OPEN) {
        try {
            ws.send(JSON.stringify(message));
        } catch (error) {
            console.error('发送WebSocket消息失败:', error);
            // 不要每次都打印到日志，避免刷屏
            if (message.type !== 'cmd_vel') {
                addLog('WebSocket发送失败: ' + error.message);
            }
        }
    } else {
        // 只对非速度命令打印警告
        if (message.type !== 'cmd_vel') {
            addLog('WebSocket未连接，无法发送消息');
        }
    }
}
```

## 测试步骤

### 1. 重启系统
```bash
cd /home/xiaoming/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot.launch.py
```

### 2. 测试地图列表加载
1. 打开浏览器（隐私模式）：http://localhost:8080
2. 等待WebSocket连接成功（看到"WebSocket连接成功"日志）
3. 等待500ms后，应该自动看到"📡 刷新地图列表..."
4. 检查"地图管理"模块的下拉框，应该显示：
   - `cleanbot_map_20251215_201805`
5. 手动点击"🔄 刷新列表"，确认功能正常

### 3. 测试摇杆控制
1. 确保在"手动"模式（默认）
2. 打开浏览器控制台（F12 → Console）
3. 拖动摇杆，观察：
   - 速度显示是否更新
   - 机器人是否移动
   - 控制台是否有错误
4. 切换到"建图"模式：
   - 观察日志："📡 请求切换导航模式: 建图 (摇杆: 启用)"
   - 测试摇杆是否可用
5. 切换到"导航"模式：
   - 观察日志："📡 请求切换导航模式: 导航 (摇杆: 禁用)"
   - 确认摇杆被禁用

### 4. 调试命令

如果问题仍然存在，运行以下命令诊断：

```bash
# 检查WebSocket连接
# 在浏览器控制台输入：
ws.readyState  # 应该返回 1 (OPEN)

# 检查摇杆状态
joystickEnabled  # 应该根据模式返回 true/false
currentNavigationMode  # 0=手动, 1=建图, 2=导航

# 检查ROS话题
ros2 topic list | grep cmd_vel
ros2 topic echo /diff_drive_controller/cmd_vel --once

# 检查地图文件
ls -la ~/cleanbot_maps/

# 监听WebSocket消息
# 在浏览器控制台输入：
ws.addEventListener('message', (event) => {
    console.log('收到消息:', event.data);
});
```

## 预期结果

### 地图列表
- ✅ WebSocket连接后自动加载地图列表
- ✅ 下拉框显示可用地图
- ✅ 手动刷新功能正常

### 摇杆控制
- ✅ 手动模式：摇杆可用
- ✅ 建图模式：摇杆可用
- ✅ 导航模式：摇杆禁用
- ✅ 控制流畅，无延迟
- ✅ 只在速度改变时发送消息（减少网络负载）

## 进一步优化建议

如果摇杆控制仍然不稳定，可以考虑：

1. **增加消息发送频率**：
   ```javascript
   setInterval(sendVelocityCommand, 50);  // 20Hz instead of 10Hz
   ```

2. **添加消息队列**：
   - 在WebSocket断开时缓存消息
   - 重连后批量发送

3. **使用二进制协议**：
   - 替换JSON为更高效的二进制格式
   - 减少消息大小和解析开销

4. **检查网络延迟**：
   ```bash
   ping localhost  # 应该 < 1ms
   ```

5. **检查CPU使用率**：
   ```bash
   top  # 查看web_control_node和浏览器的CPU占用
   ```

## 常见问题

### Q: 地图列表仍然为空
**A**: 
1. 检查地图文件是否存在：`ls ~/cleanbot_maps/`
2. 检查文件权限：`ls -la ~/cleanbot_maps/`
3. 查看浏览器控制台是否有错误
4. 查看ROS日志：`ros2 topic echo /rosout | grep web_control`

### Q: 摇杆只能控制一次就失效
**A**:
1. 检查 `joystickEnabled` 状态：在浏览器控制台输入 `joystickEnabled`
2. 检查是否误切换到导航模式
3. 刷新页面重试

### Q: 摇杆有延迟
**A**:
1. 检查WebSocket连接状态
2. 检查网络延迟
3. 尝试增加发送频率到20Hz

---
修复完成时间：2025-12-15


