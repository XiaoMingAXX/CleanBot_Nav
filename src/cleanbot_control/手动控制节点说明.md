# 手动控制节点说明

## 概述

手动控制节点（`manual_control_node.py`）是一个用于清扫机器人手动控制的核心模块，实现了遥控模式和里程闭环控制两种控制方式，并集成了红外传感器安全保护功能。

## 主要功能

### 1. 控制模式

#### 遥控模式（JOYSTICK）
- **模式值**: 0
- **功能**: 直接转发前端发送的线速度和角速度命令
- **适用场景**: 手动操作机器人，实时响应操作指令
- **红外保护**: 启用

#### 里程闭环模式（ODOMETRY）
- **模式值**: 1
- **功能**: 根据目标里程和航向，使用PID控制器实现精确移动
- **适用场景**: 需要精确移动指定距离或旋转到指定角度
- **红外保护**: 启用，触发时自动修改目标值为当前值

### 2. 路程解算

基于里程计数据计算机器人累积移动的路程：
```
路程 = ∑ √(Δx² + Δy²)
```
- 累积距离持续更新
- 通过 `/distance_feedback` 话题反馈给前端

### 3. PID控制器

#### 路程控制PID
- 控制目标: 累积路程
- 输出: 线速度 vx (m/s)
- 参数可配置: kp, ki, kd, output_limit

#### 航向控制PID
- 控制目标: 机器人航向角（yaw）
- 输出: 角速度 wz (rad/s)
- 参数可配置: kp, ki, kd, output_limit

### 4. 红外安全融合

红外传感器布局：
- **ir_down0 (右边红外)**: 触发时限制角速度 wz >= 0（禁止右转）
- **ir_down1 (前方红外)**: 触发时限制线速度 vx <= 0（禁止前进）
- **ir_down2 (左边红外)**: 触发时限制角速度 wz <= 0（禁止左转）

在里程模式下，红外触发会自动将目标值修改为当前值，避免控制器持续输出。

### 5. 导航模式适配

节点订阅 `/navigation/mode_status` 话题，仅在以下模式下发布速度命令：
- **手动模式 (MODE_MANUAL = 0)**
- **建图模式 (MODE_MAPPING = 1)**

在导航模式下（MODE_NAVIGATION = 2），节点不输出速度命令，避免干扰导航组件。

## 话题接口

### 订阅话题

| 话题名称 | 消息类型 | 功能 |
|---------|---------|------|
| `/odometry/filtered` | `nav_msgs/Odometry` | 融合后的里程计数据 |
| `/imu/data_raw` | `sensor_msgs/Imu` | IMU原始数据 |
| `/sensors_status` | `std_msgs/UInt8MultiArray` | 红外传感器状态 |
| `/navigation/mode_status` | `std_msgs/UInt8` | 导航模式状态 |
| `/manual_control_cmd` | `std_msgs/Float32MultiArray` | 前端控制命令 |

### 发布话题

| 话题名称 | 消息类型 | 功能 |
|---------|---------|------|
| `/diff_drive_controller/cmd_vel` | `geometry_msgs/TwistStamped` | 速度命令 |
| `/distance_feedback` | `std_msgs/Float32MultiArray` | 反馈数据（累积路程、航向等） |

## 控制命令格式

`/manual_control_cmd` 话题数据格式：
```python
[control_mode, linear_vel, angular_vel, target_distance, target_yaw]
```

### 遥控模式示例
```python
# 前进 0.2 m/s，左转 0.5 rad/s
[0.0, 0.2, 0.5, 0.0, 0.0]
```

### 里程模式示例
```python
# 前进 1.0 米
[1.0, 0.0, 0.0, 1.0, 0.0]

# 左转 90度（π/2 rad）
[1.0, 0.0, 0.0, 0.0, 1.5708]

# 前进1米并左转45度
[1.0, 0.0, 0.0, 1.0, 0.7854]
```

## 反馈数据格式

`/distance_feedback` 话题数据格式：
```python
[accumulated_distance, current_yaw, control_mode, navigation_mode]
```

- `accumulated_distance`: 累积路程 (m)
- `current_yaw`: 当前航向 (rad)
- `control_mode`: 当前控制模式 (0=遥控, 1=里程)
- `navigation_mode`: 当前导航模式 (0=手动, 1=建图, 2=导航)

## 参数配置

参数文件位置: `config/manual_control_params.yaml`

### 主要参数

```yaml
control_frequency: 50.0  # 控制频率 (Hz)

# 路程控制PID
distance_pid:
  kp: 0.8
  ki: 0.01
  kd: 0.15
  output_limit: 0.3  # m/s

# 航向控制PID
yaw_pid:
  kp: 1.2
  ki: 0.0
  kd: 0.25
  output_limit: 1.0  # rad/s

# 速度限制
max_linear_velocity: 0.3   # m/s
max_angular_velocity: 1.0  # rad/s

# 控制容差
distance_tolerance: 0.02   # m
yaw_tolerance: 0.05        # rad

# 红外安全
ir_triggered_max_linear_velocity: 0.0  # m/s
```

### 参数调整建议

#### PID参数调优
1. **比例系数 (kp)**: 
   - 过大：响应快但可能振荡
   - 过小：响应慢，难以到达目标
   
2. **积分系数 (ki)**:
   - 用于消除稳态误差
   - 一般设置较小值，避免积分饱和
   
3. **微分系数 (kd)**:
   - 用于抑制振荡，提高稳定性
   - 对噪声敏感，不宜过大

#### 速度限制调整
- 根据机器人实际性能和使用场景调整
- 建议先保守设置，逐步提高

#### 控制容差调整
- `distance_tolerance`: 到达目标的距离容差
- `yaw_tolerance`: 到达目标的角度容差
- 容差越小，定位越精确，但可能出现抖动

## 前端集成

### WebSocket命令格式

#### 遥控控制
```javascript
ws.send(JSON.stringify({
    type: 'cmd_vel',
    linear: 0.2,    // m/s
    angular: 0.5    // rad/s
}));
```

#### 里程控制
```javascript
ws.send(JSON.stringify({
    type: 'odometry_control',
    distance: 1.0,  // 距离增量 (m)
    yaw: 0.785      // 航向增量 (rad, π/4 = 45度)
}));
```

### 接收反馈数据
```javascript
ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'state_update') {
        const manualControl = msg.data.manual_control;
        console.log('累积路程:', manualControl.accumulated_distance);
        console.log('当前航向:', manualControl.current_yaw);
        console.log('控制模式:', manualControl.control_mode);
        console.log('导航模式:', manualControl.navigation_mode);
    }
};
```

## 使用流程

### 启动系统

#### 仿真环境
```bash
cd ~/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot_gazebo.launch.py
```

#### 实机环境
```bash
cd ~/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot.launch.py
```

### 遥控模式使用

1. 确保导航模式为"手动"或"建图"
2. 通过前端Web界面发送速度命令
3. 机器人实时响应，红外传感器自动保护

### 里程模式使用

1. 确保导航模式为"手动"或"建图"
2. 发送里程控制命令（指定距离或角度增量）
3. 机器人自动闭环控制到达目标
4. 到达目标后自动停止（满足容差条件）

## 故障排除

### 问题1: 机器人不响应控制命令

**可能原因**:
- 导航模式为"导航"模式
- 手动控制节点未启动

**解决方法**:
```bash
# 检查导航模式
ros2 topic echo /navigation/mode_status

# 检查节点是否运行
ros2 node list | grep manual_control
```

### 问题2: 里程模式下机器人抖动

**可能原因**:
- PID参数调整不当
- 控制容差设置过小

**解决方法**:
- 降低PID的kp值
- 增加kd值抑制振荡
- 适当增大容差值

### 问题3: 红外触发后机器人不动

**原因**: 这是正常的安全保护行为

**说明**:
- 前方红外触发：禁止前进
- 左/右红外触发：限制转向

### 问题4: 累积路程不准确

**可能原因**:
- 里程计漂移
- EKF融合效果不佳

**解决方法**:
- 检查轮速数据是否正常
- 调整EKF配置参数
- 定期重置累积路程（切换到里程模式时自动重置）

## 开发与调试

### 查看实时数据
```bash
# 查看累积路程和航向反馈
ros2 topic echo /distance_feedback

# 查看速度命令输出
ros2 topic echo /diff_drive_controller/cmd_vel

# 查看红外传感器状态
ros2 topic echo /sensors_status
```

### 动态调整参数
```bash
# 修改PID参数
ros2 param set /manual_control_node distance_pid.kp 1.0

# 修改速度限制
ros2 param set /manual_control_node max_linear_velocity 0.5
```

### 查看节点日志
```bash
ros2 node info /manual_control_node
```

## 注意事项

1. **模式切换**: 切换到里程模式时，目标值自动初始化为当前值，避免意外运动
2. **红外安全**: 红外触发时会自动修改目标值，需要重新发送命令才能继续运动
3. **导航兼容**: 导航模式下节点不输出，确保与Nav2系统无冲突
4. **参数调优**: 首次使用建议保守设置参数，逐步调优
5. **实时监控**: 建议通过 `/distance_feedback` 话题实时监控机器人状态

## 相关文件

- 节点源码: `scripts/manual_control_node.py`
- 参数配置: `config/manual_control_params.yaml`
- 仿真启动: `launch/cleanbot_gazebo.launch.py`
- 实机启动: `launch/cleanbot.launch.py`
- Web控制: `scripts/web_control_node.py`

