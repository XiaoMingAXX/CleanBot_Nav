<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro" name="cleanbot">
    
    <!-- 包含Gazebo仿真的ros2_control配置 -->
    <xacro:include filename="$(find cleanbot_control)/config/cleanbot_gazebo.ros2_control.xacro"/>
    
    <!-- ======================== 材质定义 ======================== -->
    <material name="white">
        <color rgba="1 1 1 0.8"/>
    </material>
    <material name="black">
        <color rgba="0 0 0 0.8"/>
    </material>
    <material name="blue">
        <color rgba="0 0 1 0.5"/>
    </material>
    <material name="grey">
        <color rgba="0.5 0.5 0.5 1.0"/>
    </material>
    
    <!-- ======================== 基础结构 ======================== -->
    
    <!-- 地面投影点 -->
    <link name="base_footprint"/>

    <!-- 机器人主体 -->
    <link name="base_link">
        <visual>
            <geometry>
                <cylinder radius="0.15" length="0.12"/>
            </geometry>
            <material name="white"/>
        </visual>
        <collision>
            <geometry>
                <cylinder radius="0.15" length="0.12"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="2.0"/>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <inertia ixx="0.0225" ixy="0.0" ixz="0.0" 
                    iyy="0.0225" iyz="0.0" izz="0.0225"/>
        </inertial>
    </link>

    <joint name="base_to_footprint" type="fixed">
        <parent link="base_footprint"/>
        <child link="base_link"/>
        <!-- 修正：抬高base_link，让底盘底部悬空（Z=0.08-0.06=0.02） -->
        <origin xyz="0 0 0.08" rpy="0 0 0"/>
    </joint>

    <!-- ======================== 轮子 ======================== -->

    <!-- 左轮 -->
    <link name="left_wheel_link">
        <visual>
            <origin xyz="0 0 0" rpy="1.57079 0 0"/>
            <geometry>
                <cylinder radius="0.032" length="0.015"/>
            </geometry>
            <material name="black"/>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="1.57079 0 0"/>
            <geometry>
                <cylinder radius="0.032" length="0.015"/>
            </geometry>
            <!-- 轮子摩擦系数 -->
            <surface>
                <friction>
                    <ode>
                        <!-- 修正：提高摩擦系数，轻微滑动更符合物理规律 -->
                        <mu>1.5</mu>
                        <mu2>1.5</mu2>
                        <slip1>0.01</slip1>
                        <slip2>0.01</slip2>
                    </ode>
                </friction>
            </surface>
        </collision>
        <inertial>
            <mass value="0.1"/>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <inertia ixx="0.00005" ixy="0.0" ixz="0.0" 
                    iyy="0.00005" iyz="0.0" izz="0.00005"/>
        </inertial>
    </link>

    <joint name="left_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="left_wheel_link"/>
        <!-- 修正：降低轮子Z位置，让轮子底部Z=0.08-0.058-0.032=-0.01（低于底盘） -->
        <origin xyz="0 0.1 -0.058" rpy="0 0 0"/>
        <axis xyz="0 1 0"/>
        <dynamics damping="0.1" friction="0.1"/>
    </joint>

    <!-- 右轮 -->
    <link name="right_wheel_link">
        <visual>
            <origin xyz="0 0 0" rpy="1.57079 0 0"/>
            <geometry>
                <cylinder radius="0.032" length="0.015"/>
            </geometry>
            <material name="black"/>
        </visual>
        <collision>
            <origin xyz="0 0 0" rpy="1.57079 0 0"/>
            <geometry>
                <cylinder radius="0.032" length="0.015"/>
            </geometry>
            <!-- 轮子摩擦系数 -->
            <surface>
                <friction>
                    <ode>
                        <!-- 修正：提高摩擦系数，轻微滑动更符合物理规律 -->
                        <mu>1.5</mu>
                        <mu2>1.5</mu2>
                        <slip1>0.01</slip1>
                        <slip2>0.01</slip2>
                    </ode>
                </friction>
            </surface>
        </collision>
        <inertial>
            <mass value="0.1"/>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <inertia ixx="0.00005" ixy="0.0" ixz="0.0" 
                    iyy="0.00005" iyz="0.0" izz="0.00005"/>
        </inertial>
    </link>

    <joint name="right_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="right_wheel_link"/>
        <!-- 修正：降低轮子Z位置，让轮子底部Z=0.08-0.058-0.032=-0.01（低于底盘） -->
        <origin xyz="0 -0.1 -0.058" rpy="0 0 0"/>
        <axis xyz="0 1 0"/>
        <dynamics damping="0.1" friction="0.1"/>
    </joint>

    <!-- ======================== 万向轮 ======================== -->

    <!-- 前万向轮 -->
    <link name="front_caster_link">
        <visual>
            <geometry>
                <!-- 修正：增大万向轮半径，提升支撑稳定性 -->
                <sphere radius="0.015"/>
            </geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry>
                <sphere radius="0.015"/>
            </geometry>
            <surface>
                <friction>
                    <ode>
                        <!-- 修正：万向轮设为低摩擦（非0），允许滚动 -->
                        <mu>0.2</mu>
                        <mu2>0.2</mu2>
                        <slip1>0.5</slip1>
                        <slip2>0.5</slip2>
                    </ode>
                </friction>
            </surface>
        </collision>
        <inertial>
            <mass value="0.01"/>
            <inertia ixx="0.000001" ixy="0.0" ixz="0.0" 
                    iyy="0.000001" iyz="0.0" izz="0.000001"/>
        </inertial>
    </link>

    <joint name="front_caster_joint" type="continuous">
        <parent link="base_link"/>
        <child link="front_caster_link"/>
        <!-- 修正：降低万向轮Z位置，底部Z=0.08-0.07-0.015=-0.005（低于底盘） -->
        <origin xyz="0.12 0 -0.07" rpy="0 0 0"/>
        <!-- 修正：万向轮绕Z轴自由旋转，减少阻力 -->
        <axis xyz="0 0 1"/>
        <dynamics damping="0.01" friction="0.01"/>
    </joint>

    <!-- 后万向轮 -->
    <link name="rear_caster_link">
        <visual>
            <geometry>
                <!-- 修正：增大万向轮半径，提升支撑稳定性 -->
                <sphere radius="0.015"/>
            </geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry>
                <sphere radius="0.015"/>
            </geometry>
            <surface>
                <friction>
                    <ode>
                        <!-- 修正：万向轮设为低摩擦（非0），允许滚动 -->
                        <mu>0.2</mu>
                        <mu2>0.2</mu2>
                        <slip1>0.5</slip1>
                        <slip2>0.5</slip2>
                    </ode>
                </friction>
            </surface>
        </collision>
        <inertial>
            <mass value="0.01"/>
            <inertia ixx="0.000001" ixy="0.0" ixz="0.0" 
                    iyy="0.000001" iyz="0.0" izz="0.000001"/>
        </inertial>
    </link>

    <joint name="rear_caster_joint" type="continuous">
        <parent link="base_link"/>
        <child link="rear_caster_link"/>
        <!-- 修正：降低万向轮Z位置，底部Z=0.08-0.07-0.015=-0.005（低于底盘） -->
        <origin xyz="-0.12 0 -0.07" rpy="0 0 0"/>
        <!-- 修正：万向轮绕Z轴自由旋转，减少阻力 -->
        <axis xyz="0 0 1"/>
        <dynamics damping="0.01" friction="0.01"/>
    </joint>

    
    <!-- ======================== 传感器 ======================== -->
    
    <!-- IMU -->
    <link name="imu_link">
        <visual>
            <geometry>
                <box size="0.02 0.02 0.02"/>
            </geometry>
            <material name="blue"/>
        </visual>
        <collision>
            <geometry>
                <box size="0.02 0.02 0.02"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="0.01"/>
            <inertia ixx="0.000001" ixy="0.0" ixz="0.0" 
                     iyy="0.000001" iyz="0.0" izz="0.000001"/>
        </inertial>
    </link>
    
    <joint name="imu_joint" type="fixed">
        <parent link="base_link"/>
        <child link="imu_link"/>
        <origin xyz="0 0 0.02" rpy="0 0 0"/>
    </joint>
    
    <!-- 激光雷达支撑杆 -->
    <link name="laser_support_link">
        <visual>
            <geometry>
                <cylinder radius="0.01" length="0.08"/>
            </geometry>
            <material name="grey"/>
        </visual>
        <collision>
            <geometry>
                <cylinder radius="0.01" length="0.08"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="0.05"/>
            <inertia ixx="0.0001" ixy="0.0" ixz="0.0" 
                     iyy="0.0001" iyz="0.0" izz="0.00001"/>
        </inertial>
    </link>
    
    <joint name="laser_support_joint" type="fixed">
        <parent link="base_link"/>
        <child link="laser_support_link"/>
        <origin xyz="0.1 0 0.05" rpy="0 0 3.14"/>
    </joint>
    
    <!-- 激光雷达 (RPLidar A1) -->
    <link name="laser">
        <visual>
            <geometry>
                <cylinder radius="0.035" length="0.04"/>
            </geometry>
            <material name="black"/>
        </visual>
        <collision>
            <geometry>
                <cylinder radius="0.035" length="0.04"/>
            </geometry>
        </collision>
        <inertial>
            <mass value="0.15"/>
            <inertia ixx="0.0001" ixy="0.0" ixz="0.0" 
                     iyy="0.0001" iyz="0.0" izz="0.0001"/>
        </inertial>
    </link>
    
    <joint name="laser_joint" type="fixed">
        <parent link="laser_support_link"/>
        <child link="laser"/>
        <origin xyz="0 0 0.06" rpy="0 0 0"/>
    </joint>
    
    <!-- ======================== ros2_control ======================== -->
    <xacro:cleanbot_ros2_control_gazebo/>
    
    <!-- ======================== Gazebo插件 ======================== -->
    
    <!-- Gazebo ros2_control插件 -->
    <gazebo>
        <plugin filename="libgz_ros2_control-system.so" name="gz_ros2_control::GazeboSimROS2ControlPlugin">
            <parameters>$(find cleanbot_control)/config/cleanbot_controllers.yaml</parameters>
            <ros>
                <namespace>/</namespace>
                <remapping>~/robot_description:=/robot_description</remapping>
            </ros>
            <controller_manager_name>controller_manager</controller_manager_name>
        </plugin>
    </gazebo>
    
    <!-- IMU传感器插件 -->
    <gazebo reference="imu_link">
        <sensor name="imu_sensor" type="imu">
            <always_on>1</always_on>
            <update_rate>100</update_rate>
            <visualize>true</visualize>
            <topic>/imu_raw</topic>
            <frame_id>imu_link</frame_id>
            <imu>
                <angular_velocity>
                    <x>
                        <noise type="gaussian">
                            <mean>0.0</mean>
                            <stddev>0.002</stddev>
                        </noise>
                    </x>
                    <y>
                        <noise type="gaussian">
                            <mean>0.0</mean>
                            <stddev>0.002</stddev>
                        </noise>
                    </y>
                    <z>
                        <noise type="gaussian">
                            <mean>0.0</mean>
                            <stddev>0.002</stddev>
                        </noise>
                    </z>
                </angular_velocity>
                <linear_acceleration>
                    <x>
                        <noise type="gaussian">
                            <mean>0.0</mean>
                            <stddev>0.017</stddev>
                        </noise>
                    </x>
                    <y>
                        <noise type="gaussian">
                            <mean>0.0</mean>
                            <stddev>0.017</stddev>
                        </noise>
                    </y>
                    <z>
                        <noise type="gaussian">
                            <mean>0.0</mean>
                            <stddev>0.017</stddev>
                        </noise>
                    </z>
                </linear_acceleration>
            </imu>
        </sensor>
    </gazebo>
    
    <!-- 激光雷达传感器插件 -->
    <gazebo reference="laser">
        <sensor name="laser_sensor" type="gpu_lidar">
            <topic>/scan_raw</topic>
            <update_rate>10</update_rate>
            <frame_id>laser</frame_id>
            <lidar>
                <scan>
                    <horizontal>
                        <samples>360</samples>
                        <resolution>1</resolution>
                        <min_angle>0.0</min_angle>
                        <max_angle>6.28319</max_angle>
                    </horizontal>
                </scan>
                <range>
                    <min>0.12</min>
                    <max>12.0</max>
                    <resolution>0.01</resolution>
                </range>
                <noise>
                    <type>gaussian</type>
                    <mean>0.0</mean>
                    <stddev>0.01</stddev>
                </noise>
            </lidar>
            <always_on>1</always_on>
            <visualize>true</visualize>
        </sensor>
    </gazebo>
    
    <!-- 为所有链接设置Gazebo材质 -->
    <gazebo reference="base_link">
        <material>Gazebo/White</material>
        <mu1>0.2</mu1>
        <mu2>0.2</mu2>
    </gazebo>
    
    <gazebo reference="left_wheel_link">
        <material>Gazebo/Black</material>
        <mu1>1.0</mu1>
        <mu2>1.0</mu2>
        <kp>1000000.0</kp>
        <kd>100.0</kd>
        <minDepth>0.001</minDepth>
    </gazebo>
    
    <gazebo reference="right_wheel_link">
        <material>Gazebo/Black</material>
        <mu1>1.0</mu1>
        <mu2>1.0</mu2>
        <kp>1000000.0</kp>
        <kd>100.0</kd>
        <minDepth>0.001</minDepth>
    </gazebo>
    
    <gazebo reference="front_caster_link">
        <material>Gazebo/Grey</material>
        <mu1>0.0</mu1>
        <mu2>0.0</mu2>
    </gazebo>
    
    <gazebo reference="rear_caster_link">
        <material>Gazebo/Grey</material>
        <mu1>0.0</mu1>
        <mu2>0.0</mu2>
    </gazebo>
    
    <gazebo reference="laser_support_link">
        <material>Gazebo/Grey</material>
    </gazebo>
    
    <gazebo reference="laser">
        <material>Gazebo/Black</material>
    </gazebo>
    
</robot>

