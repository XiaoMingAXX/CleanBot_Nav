# 导航功能测试指南

## 🔄 重新编译和启动

```bash
cd ~/桌面/MOON/Electronic/CleanBot_ws

# 编译修改的包
colcon build --packages-select cleanbot_control cleanbot_navigation

# 刷新环境
source install/setup.bash
```

## 🚀 启动系统

### 终端1：机器人控制
```bash
ros2 launch cleanbot_control robot_bringup.launch.py
```

### 终端2：Web控制
```bash
ros2 launch cleanbot_control web_control.launch.py
```

### 终端3：导航系统
```bash
ros2 launch cleanbot_navigation navigation_bringup.launch.py
```

### 浏览器：打开控制界面
```
http://localhost:8080
```

## ✅ 测试清单

### 1. 摇杆控制修复测试

#### 手动模式（默认）
- [ ] 页面加载后，摇杆应该可用
- [ ] 信息提示：`✅ 摇杆控制已启用`
- [ ] 移动摇杆，机器人响应

#### 建图模式（修复的bug）
- [ ] 点击"建图"按钮
- [ ] 等待状态变为"✅ 就绪"
- [ ] **摇杆应该可用**（这是修复的bug）
- [ ] 信息提示：`✅ 摇杆可用，驾驶建图`
- [ ] 移动摇杆，机器人响应
- [ ] 在RViz2中观察建图过程

#### 导航模式
- [ ] 点击"导航"按钮
- [ ] 等待状态变为"✅ 就绪"
- [ ] 摇杆应该禁用（无响应）
- [ ] 信息提示：`⚠️ 自主导航中，摇杆已禁用`

### 2. 状态反馈测试

#### 模式切换反馈
- [ ] 点击任意模式按钮
- [ ] 立即显示：状态 = "切换中..." （黄色）
- [ ] 系统日志：`📡 请求切换导航模式: xxx`
- [ ] 等待2-5秒
- [ ] 状态变为："✅ 就绪" （绿色）
- [ ] 系统日志：`✅ 模式切换完成: xxx`

#### 地图保存反馈
- [ ] 切换到建图模式
- [ ] 手动驾驶一段距离
- [ ] 点击"💾 保存地图"按钮
- [ ] 立即显示：状态 = "保存中..." （黄色）
- [ ] 系统日志：`📡 发送保存地图请求...`
- [ ] 等待地图保存
- [ ] 状态变为："✅ 地图已保存" （绿色）
- [ ] 系统日志：`✅ 地图保存成功: cleanbot_map_xxx`

### 3. 地图列表功能测试

#### 初始加载
- [ ] 页面首次加载
- [ ] 系统日志：`📡 刷新地图列表...`
- [ ] 系统日志：`✅ 发现 X 个地图`

#### 保存后自动刷新
- [ ] 保存地图成功后
- [ ] 地图列表自动刷新
- [ ] 新保存的地图出现在列表顶部

#### 切换到导航模式刷新
- [ ] 切换到"导航"模式
- [ ] 地图列表自动刷新
- [ ] 显示地图选择下拉框

#### 手动刷新
- [ ] 在导航模式下
- [ ] 点击"🔄 刷新列表"按钮
- [ ] 地图列表更新

### 4. 地图选择和加载测试

#### 选择地图
- [ ] 切换到导航模式
- [ ] 点击地图下拉框
- [ ] 应该看到所有已保存的地图
- [ ] 地图按时间倒序排列（最新在上）

#### 加载地图
- [ ] 选择一个地图
- [ ] 点击"📍 加载地图"按钮
- [ ] 状态显示："加载地图中..." （黄色）
- [ ] 系统日志：`📡 加载地图: xxx`
- [ ] 收到反馈消息

### 5. UI动态显示测试

#### 手动模式
- [ ] 无特殊控件
- [ ] 只显示模式按钮和状态

#### 建图模式
- [ ] 显示"💾 保存地图"按钮
- [ ] 隐藏地图选择控件

#### 导航模式
- [ ] 隐藏保存地图按钮
- [ ] 显示地图选择下拉框
- [ ] 显示"📍 加载地图"按钮
- [ ] 显示"🔄 刷新列表"按钮

## 🧪 完整建图和导航流程

### 建图流程
1. **切换到建图模式**
   ```
   点击"建图" → 等待"✅ 就绪"
   ```

2. **手动驾驶建图**
   ```
   使用摇杆控制机器人移动
   在RViz2中观察地图生成
   尽量形成闭环路径
   ```

3. **保存地图**
   ```
   点击"💾 保存地图"
   等待"✅ 地图已保存"
   查看系统日志中的地图名称
   ```

4. **验证地图文件**
   ```bash
   ls -lh ~/cleanbot_maps/
   # 应该看到新生成的 .yaml 和 .pgm 文件
   ```

### 导航流程
1. **切换到导航模式**
   ```
   点击"导航" → 等待"✅ 就绪"
   摇杆自动禁用
   ```

2. **选择地图**
   ```
   打开地图下拉框
   选择刚才保存的地图
   点击"📍 加载地图"
   ```

3. **设置目标点**（在RViz2中）
   ```
   点击"2D Goal Pose"工具
   在地图上点击目标位置
   机器人开始自主导航
   ```

4. **监控导航**
   ```
   在RViz2中观察路径和机器人位置
   Web界面查看里程计数据
   确认摇杆无法控制
   ```

## 📝 检查地图文件

```bash
# 列出所有地图
ls -lh ~/cleanbot_maps/

# 查看地图元数据
cat ~/cleanbot_maps/cleanbot_map_20251215_xxx.yaml

# 用图像查看器打开地图
eog ~/cleanbot_maps/cleanbot_map_20251215_xxx.pgm

# 或用GIMP编辑
gimp ~/cleanbot_maps/cleanbot_map_20251215_xxx.pgm
```

## 🐛 故障排查

### 摇杆在建图模式仍不可用
**检查**：
```javascript
// 在浏览器Console中输入：
console.log('当前模式:', currentNavigationMode);
console.log('摇杆启用:', joystickEnabled);

// 应该显示：
// 当前模式: 1
// 摇杆启用: true
```

**解决**：刷新页面（Ctrl+F5）

### 状态一直显示"切换中..."
**原因**：ROS节点未正确发送反馈

**检查**：
```bash
# 查看navigation_mode_manager日志
ros2 node list | grep navigation
ros2 node info /navigation_mode_manager

# 查看话题
ros2 topic echo /navigation/info
```

### 地图列表为空
**检查地图目录**：
```bash
ls -la ~/cleanbot_maps/
```

**检查Web节点日志**：
```bash
# 终端2的输出
# 应该看到：发送地图列表: X个地图
```

### 地图保存失败
**检查**：
1. 是否在建图模式
2. SLAM节点是否正常运行
3. 地图目录是否有写权限

```bash
# 检查SLAM状态
ros2 node list | grep slam
ros2 topic hz /map

# 检查目录权限
mkdir -p ~/cleanbot_maps
chmod 755 ~/cleanbot_maps
```

## ✨ 预期效果

### 建图模式
- 摇杆：✅ 可用
- 控件：保存地图按钮
- 提示：✅ 摇杆可用，驾驶建图

### 导航模式
- 摇杆：❌ 禁用
- 控件：地图选择、加载、刷新按钮
- 提示：⚠️ 自主导航中，摇杆已禁用

### 状态反馈
- 切换时：⚠️ 切换中...
- 完成后：✅ 就绪
- 保存时：⚠️ 保存中...
- 保存后：✅ 地图已保存

## 🎯 成功标准

- [x] 建图模式下摇杆可用
- [x] 模式切换有状态反馈
- [x] 地图保存成功有提示
- [x] 可以查看已保存的地图
- [x] 可以选择地图用于导航
- [x] UI根据模式动态变化
- [x] 日志输出清晰明确

## 📞 需要帮助？

如果测试过程中遇到问题：
1. 查看浏览器Console（F12）
2. 查看ROS节点日志
3. 检查~/cleanbot_maps/目录
4. 参考故障排查章节

---

**测试愉快！** 🎉






