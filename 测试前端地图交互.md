# 前端导航地图交互功能测试指南

## 快速测试步骤

### 准备工作

#### 1. 启动系统
```bash
# 终端1: 启动基础控制和Web界面
cd ~/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_control cleanbot.launch.py

# 终端2: 启动导航系统(模拟模式)
cd ~/桌面/MOON/Electronic/CleanBot_ws
source install/setup.bash
ros2 launch cleanbot_navigation navigation_sim.launch.py
```

#### 2. 打开浏览器
```
http://localhost:8080
```

---

## 功能测试清单

### ✅ 测试1: 障碍物信息显示

**目标**: 验证地图中的障碍物是否正确显示

**步骤**:
1. 切换到"建图模式"
2. 等待建图启动完成(约10-15秒)
3. 使用摇杆控制机器人移动
4. 观察地图区域:
   - ⬜ **白色方格** = 障碍物
   - 灰色区域 = 未知区域
   - 黑色区域 = 可通行区域

**预期结果**: 
- 地图实时更新
- 障碍物显示为白色
- 地图中央网格清晰可见

---

### ✅ 测试2: TF位姿和自动居中

**目标**: 验证机器人位姿从TF获取并自动居中

**步骤**:
1. 在建图模式下移动机器人
2. 观察机器人图标:
   - 🟦 蓝色圆圈
   - 白色箭头指向前方
3. 观察机器人是否始终保持在画布中央
4. 查看左上角叠加层的坐标值是否实时更新

**预期结果**:
- 机器人始终在画布中央
- 坐标值实时更新
- 方向箭头正确指向机器人朝向

---

### ✅ 测试3: 缩放控制

**目标**: 验证地图缩放功能

**步骤**:
1. 点击右上角 `+` 按钮多次
   - 观察地图放大
   - 机器人图标变大
2. 点击右上角 `-` 按钮多次
   - 观察地图缩小
   - 机器人图标变小
3. 点击 `📍` 按钮
   - 按钮高亮 = 自动居中开启
   - 按钮暗淡 = 自动居中关闭

**预期结果**:
- 缩放流畅，范围合理 (5x ~ 100x)
- 自动居中开关有效
- 关闭自动居中后可以查看地图其他区域

---

### ✅ 测试4: 地图保存和加载

**目标**: 验证地图保存和加载功能

**步骤**:
1. 在建图模式下建完地图
2. 点击"保存当前地图"
3. 等待保存完成(提示: "✅ 已保存: xxx")
4. 点击"刷新列表"
5. 在"导航地图选择"下拉框中看到新保存的地图

**预期结果**:
- 地图保存成功
- 列表中出现新地图
- 可以选择地图

---

### ✅ 测试5: AMCL初始化

**目标**: 验证AMCL初始化的两次点击流程

**步骤**:
1. 切换到"导航模式"
2. 选择一个已保存的地图
3. 等待导航系统启动(约15秒)
4. **第一次点击**地图任意位置
   - 观察蓝色闪烁圆圈出现
   - 日志提示: "📍 AMCL初始化: 已选择位置，请点击设置方向"
5. **第二次点击**地图另一个位置(设置方向)
   - 日志提示: "✅ AMCL初始化完成: (x, y, θ°)"
   - 蓝色标记消失

**预期结果**:
- 第一次点击显示蓝色标记
- 第二次点击完成初始化
- 机器人位姿在地图上对齐

---

### ✅ 测试6: 导航目标点发布

**目标**: 验证点击发布导航目标点

**步骤**:
1. 确保在"导航模式"且已完成AMCL初始化
2. 确保工作模式为"待机"
3. 点击地图上的任意可通行位置
4. 观察:
   - 🟩 绿色圆圈出现(用户目标点)
   - 日志提示: "设置目标点: (x, y)"
5. 等待导航执行
6. 观察:
   - 🟥 红色圆圈可能出现(执行目标点)
   - 机器人开始移动

**预期结果**:
- 绿色目标点正确显示
- 红色执行目标点可能在不同位置(取决于全局规划器)
- 机器人自主导航到目标

---

### ✅ 测试7: 清扫模式路径显示

**目标**: 验证清扫规划路径显示

**步骤**:
1. 确保在"导航模式"且已完成AMCL初始化
2. 选择工作模式: "自动全屋"、"沿边"或"弓形"
3. 等待路径规划完成(约2-5秒)
4. 观察:
   - 🟨 黄色虚线路径出现
   - 路径覆盖清扫区域
5. 观察左上角叠加层的"清扫进度"

**预期结果**:
- 黄色虚线路径清晰显示
- 路径符合选择的模式(沿边/弓形/全屋)
- 清扫进度实时更新: `5/10 (50.0%)`

---

### ✅ 测试8: 目标点区分显示

**目标**: 验证用户目标点和执行目标点分开显示

**步骤**:
1. 在导航模式下点击地图设置目标点
2. 观察两个圆圈:
   - 🟩 **绿色** "目标" = 用户设置的点
   - 🟥 **红色** "执行中" = 导航实际执行的点
3. 注意两者可能位置不同(规划器会调整)

**预期结果**:
- 两个目标点同时显示
- 颜色和标签不同
- 用户点击的位置显示绿色
- 实际导航的位置显示红色

---

### ✅ 测试9: 清扫进度可视化

**目标**: 验证清扫进度显示

**步骤**:
1. 启动任意清扫模式
2. 观察左上角叠加层的"清扫进度"
3. 等待清扫执行
4. 观察进度数字变化:
   - `0/10 (0.0%)` → `5/10 (50.0%)` → `10/10 (100.0%)`

**预期结果**:
- 进度实时更新
- 百分比准确
- 完成后显示100%

---

### ✅ 测试10: 模式切换限制

**目标**: 验证清扫模式下禁止手动发布目标点

**步骤**:
1. 启动清扫模式(沿边/弓形/全屋)
2. 尝试点击地图
3. 观察日志提示: "⚠️ 清扫模式下无法手动发送目标点"

**预期结果**:
- 清扫模式下点击地图无效
- 显示警告提示
- 不发布新的导航目标点

---

## 调试技巧

### 查看ROS话题
```bash
# 查看地图数据
ros2 topic echo /map --once

# 查看规划路径
ros2 topic echo /cleaning/planned_path --once

# 查看TF变换
ros2 run tf2_ros tf2_echo map base_link

# 查看AMCL初始位姿
ros2 topic echo /initialpose --once

# 查看导航目标点
ros2 topic echo /goal_pose --once
```

### 查看浏览器控制台
按 `F12` 打开开发者工具，查看:
- `Console` 标签: JavaScript日志和错误
- `Network` 标签: WebSocket连接状态
- `[导航调试]` 前缀的日志: 导航相关调试信息
- `[摇杆调试]` 前缀的日志: 摇杆控制调试信息

### 常见问题

**Q: 地图不显示障碍物?**
A: 检查 `/map` 话题是否发布，确认建图模式已启动

**Q: 机器人不在画布中央?**
A: 点击 `📍` 按钮启用自动居中

**Q: 点击地图没反应?**
A: 确认是否在"导航模式"，建图和手动模式下无法发布目标点

**Q: AMCL初始化失败?**
A: 
1. 检查是否在导航模式
2. 确认地图已加载
3. 查看 `/initialpose` 话题是否收到消息

**Q: 路径不显示?**
A: 
1. 确认清扫模式已启动
2. 等待路径规划完成(约2-5秒)
3. 检查 `/cleaning/planned_path` 话题

**Q: 清扫进度不更新?**
A: 检查 `/cleaning/task_info` 话题是否发布进度信息

---

## 性能测试

### 帧率测试
- 在浏览器控制台输入: `console.log('FPS: ' + (1000 / 100))` 
- 正常应为 **10 FPS** (地图刷新频率)

### 延迟测试
- 移动机器人，观察地图更新延迟
- 正常应 < **200ms**

### 内存测试
- 长时间运行(30分钟)，观察浏览器内存占用
- 正常应 < **500MB**

---

## 测试总结模板

```
测试日期: __________
测试人员: __________

功能测试结果:
[ ] 障碍物信息显示
[ ] TF位姿和自动居中
[ ] 缩放控制
[ ] 地图保存和加载
[ ] AMCL初始化
[ ] 导航目标点发布
[ ] 清扫模式路径显示
[ ] 目标点区分显示
[ ] 清扫进度可视化
[ ] 模式切换限制

发现的问题:
1. ___________________________________
2. ___________________________________
3. ___________________________________

性能表现:
- 帧率: _______ FPS
- 延迟: _______ ms
- 内存占用: _______ MB

总体评价: [ ] 优秀  [ ] 良好  [ ] 一般  [ ] 需改进
```

---

**测试完成后请将结果反馈给开发团队!**

