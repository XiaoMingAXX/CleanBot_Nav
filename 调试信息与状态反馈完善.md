# 调试信息与状态反馈完善

## 修复日期
2025-12-15

## 改进内容

### 改进1：添加摇杆调试信息

#### 问题
- 摇杆依然可能失灵
- 难以诊断问题原因
- 缺少运行时调试信息

#### 解决方案

**添加详细的控制台日志**：

```javascript
// 1. 拖拽开始/结束日志
console.log('[摇杆调试] 开始拖拽, 摇杆启用:', joystickEnabled, '导航模式:', currentNavigationMode);
console.log('[摇杆调试] 结束拖拽, 发送停止命令');

// 2. 速度改变日志
console.log(`[摇杆调试] 速度改变: (${lastSentLinear}, ${lastSentAngular}) -> (${currentLinear}, ${currentAngular})`);

// 3. 定期统计日志（每5秒）
console.log(`[摇杆调试] 已发送${cmdVelSendCount}条命令, WebSocket状态:${ws.readyState}, 当前速度: linear=${currentLinear}, angular=${currentAngular}, 拖拽中:${isDragging}`);

// 4. 摇杆被禁用时的警告
console.log('[摇杆调试] 摇杆被禁用，当前模式:', currentNavigationMode, '速度:', currentLinear, currentAngular);
```

#### 调试信息说明

| 日志类型 | 触发时机 | 包含信息 | 用途 |
|---------|---------|---------|------|
| 拖拽开始 | 按下摇杆 | joystickEnabled, navigationMode | 确认摇杆状态和模式 |
| 拖拽结束 | 松开摇杆 | 发送停止命令 | 确认停止命令发送 |
| 速度改变 | 速度值改变 | 旧速度 -> 新速度 | 跟踪速度变化 |
| 定期统计 | 每5秒（移动时） | 发送计数、连接状态、当前速度 | 性能监控 |
| 禁用警告 | 摇杆被禁用但有速度 | 当前模式、速度值 | 发现异常情况 |

#### 使用方法

**打开浏览器控制台**：
```
1. 按 F12 打开开发者工具
2. 点击 "Console" 标签
3. 操作摇杆，观察调试信息
```

**典型调试场景**：

**场景1：摇杆拖不动**
```
[摇杆调试] 开始拖拽, 摇杆启用: false, 导航模式: 2
[摇杆调试] 摇杆被禁用，当前模式: 2, 速度: 0.5 -0.3
```
**诊断**：摇杆在导航模式被禁用（正常行为）

**场景2：速度不改变**
```
[摇杆调试] 开始拖拽, 摇杆启用: true, 导航模式: 0
// ... 没有"速度改变"的日志
```
**诊断**：拖拽事件没有触发速度计算，检查drag函数

**场景3：命令不发送**
```
[摇杆调试] 速度改变: (0, 0) -> (0.5, 0)
[摇杆调试] 已发送0条命令, WebSocket状态:0
```
**诊断**：WebSocket未连接（readyState=0），命令无法发送

**场景4：正常运行**
```
[摇杆调试] 开始拖拽, 摇杆启用: true, 导航模式: 0
[摇杆调试] 速度改变: (0, 0) -> (0.5, 0.2)
[摇杆调试] 已发送50条命令, WebSocket状态:1, 当前速度: linear=0.50, angular=0.20, 拖拽中:true
[摇杆调试] 结束拖拽, 发送停止命令
[摇杆调试] 速度改变: (0.5, 0.2) -> (0, 0)
```
**诊断**：一切正常

#### WebSocket状态码

| readyState | 含义 | 说明 |
|------------|------|------|
| 0 | CONNECTING | 正在连接 |
| 1 | OPEN | 已连接，可发送 |
| 2 | CLOSING | 正在关闭 |
| 3 | CLOSED | 已关闭 |

---

### 改进2：完善导航模式状态反馈

#### 问题
- 只显示"切换中"，没有成功/失败结果
- 后端状态反馈不完整
- 用户不知道切换是否成功

#### 解决方案

**后端改进（navigation_mode_manager.py）**：

1. **activate_slam 详细错误反馈**：
```python
# 服务未找到
if not self.slam_change_state_client.wait_for_service(timeout_sec=2.0):
    info_msg.data = 'mode_failed:SLAM节点服务未找到'
    self.info_pub.publish(info_msg)
    return False

# 配置失败
if not success:
    info_msg.data = 'mode_failed:SLAM配置失败'
    self.info_pub.publish(info_msg)
    return False

# 激活失败
if not success:
    info_msg.data = 'mode_failed:SLAM激活失败'
    self.info_pub.publish(info_msg)
    return False
```

2. **activate_navigation 详细错误反馈**：
```python
# 地图服务器未启动
if not self.map_server_active:
    info_msg.data = 'mode_failed:地图服务器未启动,请先选择地图并启动地图服务器'
    self.info_pub.publish(info_msg)
    return False

# AMCL服务未找到
if not self.amcl_change_state_client.wait_for_service(timeout_sec=2.0):
    info_msg.data = 'mode_failed:AMCL服务未找到'
    self.info_pub.publish(info_msg)
    return False

# AMCL配置失败
if not success:
    info_msg.data = 'mode_failed:AMCL配置失败'
    self.info_pub.publish(info_msg)
    return False

# AMCL激活失败
if not success:
    info_msg.data = 'mode_failed:AMCL激活失败'
    self.info_pub.publish(info_msg)
    return False
```

3. **switch_mode 避免重复发送**：
```python
if not success:
    self.get_logger().error(f'❌ 模式切换失败: {self.MODE_NAMES[new_mode]}')
    self.current_mode = self.MODE_MANUAL
    # activate函数已经发送了详细的mode_failed消息，这里不再重复发送
    return
```

**前端处理（control.js）**：

已经在之前实现：
```javascript
else if (info.startsWith('mode_failed:')) {
    const error = info.split(':')[1] || '未知错误';
    stateElement.textContent = '❌ 切换失败';
    stateElement.style.color = 'var(--danger)';
    addLog(`❌ 模式切换失败: ${error}`);
    
    // 3秒后恢复就绪状态
    setTimeout(() => {
        stateElement.textContent = '✅ 就绪';
        stateElement.style.color = 'var(--success)';
    }, 3000);
}
```

#### 状态转换流程

**成功流程**：
```
用户点击"建图"
  ↓
前端：⏳ 切换中...
  ↓
后端：slam_activating (SLAM启动中)
  ↓
后端：SLAM配置 → 成功
  ↓
后端：SLAM激活 → 成功
  ↓
后端：mode_changed:mapping
  ↓
前端：✅ 就绪
```

**失败流程1：服务未找到**：
```
用户点击"建图"
  ↓
前端：⏳ 切换中...
  ↓
后端：slam_activating
  ↓
后端：SLAM服务未找到
  ↓
后端：mode_failed:SLAM节点服务未找到
  ↓
前端：❌ 切换失败
  ↓
3秒后：✅ 就绪
```

**失败流程2：地图服务器未启动**：
```
用户点击"导航"
  ↓
前端：⏳ 切换中...
  ↓
后端：nav_activating
  ↓
后端：检查地图服务器 → 未启动
  ↓
后端：mode_failed:地图服务器未启动,请先选择地图并启动地图服务器
  ↓
前端：❌ 切换失败
  ↓
前端日志：❌ 模式切换失败: 地图服务器未启动,请先选择地图并启动地图服务器
  ↓
3秒后：✅ 就绪
```

#### 错误消息列表

| 错误类型 | 消息内容 | 解决方法 |
|---------|---------|---------|
| SLAM服务未找到 | SLAM节点服务未找到 | 检查SLAM节点是否启动 |
| SLAM配置失败 | SLAM配置失败 | 检查SLAM配置文件 |
| SLAM激活失败 | SLAM激活失败 | 查看ROS日志 |
| 地图服务器未启动 | 地图服务器未启动,请先选择地图并启动地图服务器 | 在地图管理模块选择地图并启动 |
| AMCL服务未找到 | AMCL服务未找到 | 检查导航节点是否启动 |
| AMCL配置失败 | AMCL配置失败 | 检查AMCL配置文件 |
| AMCL激活失败 | AMCL激活失败 | 查看ROS日志 |
| 系统异常 | 系统异常:... | 查看完整错误堆栈 |

---

## 测试验证

### 测试1：摇杆调试信息

**步骤**：
1. 打开浏览器：http://localhost:8080
2. **强制刷新**：`Ctrl + Shift + R`
3. 按 F12 打开控制台
4. 操作摇杆

**预期输出**：
```
[摇杆调试] 开始拖拽, 摇杆启用: true, 导航模式: 0
[摇杆调试] 速度改变: (0.00, 0.00) -> (0.35, 0.12)
[摇杆调试] 已发送50条命令, WebSocket状态:1, 当前速度: linear=0.35, angular=0.12, 拖拽中:true
[摇杆调试] 结束拖拽, 发送停止命令
[摇杆调试] 速度改变: (0.35, 0.12) -> (0.00, 0.00)
```

### 测试2：导航模式切换反馈

**测试2.1：建图模式成功**
```bash
# 确保SLAM节点正在运行
ros2 node list | grep slam
```

操作：点击"建图"按钮

预期：
- 状态：⏳ 切换中... → ✅ 就绪
- 日志：✅ 模式切换完成: mapping
- 时间：1-2秒

**测试2.2：导航模式失败（地图服务器未启动）**

操作：
1. 确保地图服务器未启动
2. 点击"导航"按钮

预期：
- 状态：⏳ 切换中... → ❌ 切换失败
- 日志：❌ 模式切换失败: 地图服务器未启动,请先选择地图并启动地图服务器
- 3秒后恢复：✅ 就绪

**测试2.3：导航模式成功**

操作：
1. 在地图管理模块选择地图
2. 点击"启动地图服务器"，等待运行中
3. 点击"导航"按钮

预期：
- 状态：⏳ 切换中... → ✅ 就绪
- 日志：✅ 模式切换完成: navigation
- 时间：1-2秒

### 测试3：模拟各种失败场景

**场景1：SLAM节点未启动**
```bash
# 停止SLAM节点（如果在运行）
ros2 lifecycle set /slam_toolbox shutdown
```
操作：点击"建图"
预期：❌ 切换失败: SLAM节点服务未找到

**场景2：导航节点未启动**
```bash
# 停止AMCL节点（如果在运行）
ros2 lifecycle set /amcl shutdown
```
操作：点击"导航"
预期：❌ 切换失败: AMCL服务未找到

---

## 调试技巧

### 1. 查看摇杆状态
```javascript
// 在浏览器控制台输入
console.log({
    joystickEnabled,
    currentNavigationMode,
    isDragging,
    currentLinear,
    currentAngular,
    lastSentLinear,
    lastSentAngular,
    cmdVelSendCount,
    wsState: ws ? ws.readyState : null
});
```

### 2. 监测ROS话题
```bash
# 监测速度命令
ros2 topic echo /diff_drive_controller/cmd_vel

# 监测发布频率
ros2 topic hz /diff_drive_controller/cmd_vel

# 监测导航状态
ros2 topic echo /navigation/info
```

### 3. 查看ROS节点状态
```bash
# 查看SLAM节点状态
ros2 lifecycle get /slam_toolbox

# 查看AMCL节点状态
ros2 lifecycle get /amcl

# 查看所有lifecycle节点
ros2 lifecycle nodes
```

### 4. 启用详细日志
```bash
# 启动时添加日志级别
ros2 launch cleanbot_navigation navigation_bringup.launch.py \
    log_level:=debug
```

---

## 常见问题排查

### 问题：摇杆拖不动

**检查清单**：
1. 打开控制台，看是否有"摇杆被禁用"的日志
2. 检查 `currentNavigationMode`，导航模式(2)会禁用摇杆
3. 检查 `isDragging` 是否为 true
4. 检查是否有"速度改变"的日志

### 问题：速度命令发送但机器人不动

**检查清单**：
1. 检查 WebSocket 状态：应该是 1 (OPEN)
2. 监测ROS话题：`ros2 topic echo /diff_drive_controller/cmd_vel`
3. 检查控制器是否运行：`ros2 node list | grep controller`
4. 检查USB连接状态

### 问题：模式切换一直显示"切换中"

**检查清单**：
1. 查看ROS日志：`ros2 topic echo /rosout | grep navigation_mode_manager`
2. 检查是否收到 `mode_changed` 或 `mode_failed` 消息
3. 检查lifecycle节点是否响应
4. 查看后端是否有异常输出

### 问题：导航模式切换失败

**检查清单**：
1. 地图服务器是否已启动
2. 地图文件是否存在
3. AMCL节点是否运行
4. 查看详细错误消息

---

## 文件修改清单

| 文件 | 修改内容 | 行数 |
|------|---------|------|
| `src/cleanbot_control/web/static/control.js` | 添加摇杆调试信息 | +30 |
| `src/cleanbot_navigation/cleanbot_navigation/navigation_mode_manager.py` | 完善错误反馈 | +40 |
| `src/cleanbot_control/web/templates/index.html` | 更新版本号 v=20251215-4 | 1 |

**总计**: 约71行代码修改

---

## 总结

### 改进亮点

1. **详细的调试信息**：
   - 实时跟踪摇杆状态
   - 记录速度变化
   - 监控发送频率
   - 诊断WebSocket连接

2. **完善的状态反馈**：
   - 每个失败点都有明确的错误消息
   - 用户知道具体的失败原因
   - 提供解决建议

3. **更好的用户体验**：
   - 失败时显示具体错误
   - 自动恢复到就绪状态
   - 日志清晰易懂

### 下一步建议

1. 收集用户反馈，根据实际问题调整日志级别
2. 考虑添加性能监控面板
3. 实现错误统计和报告功能

---

**修复完成**: 2025-12-15  
**版本**: v=20251215-4  
**测试状态**: 待用户验证





